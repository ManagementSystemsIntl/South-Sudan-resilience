---
title: "Resilience explore"
author: "Dan Killian"
date: "11/19/2021"
output: 
  bookdown::html_document2:
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float: true
    theme: paper
    fig.caption: true
    code_folding: hide
    df_print: kable
---

```{r global_options, include=F, warning=F, message=F, echo=F, error=F}
# standard figure size and generate clean output
knitr::opts_chunk$set(fig.height=4, fig.width=6, warning=FALSE, message=FALSE, cache=TRUE, error=T, echo=T)

library(here)

#knitr::opts_knit$set(root.dir="~/South Sudan resilience - MSI") # doesn't seem to work

source(here("code/00 South Sudan resilience - prep.R"))

```

# Introduction

The South Sudan Monitoring and Evaluation Support Project (MESP) is conducting a household resilience survey in 13 counties. The purpose of this household survey is to obtain baseline data in the target areas for the indicators included in the Mission's Performance Management Plan (PMP) and the Community Roadmap, in support of USAID/South Sudan's Strategic Framework (2020-2024).

MESP has completed data collection in six counties, and as of October 2021 is carrying out data collection in the remaining seven counties. The study team is currently reviewing the data from six counties in advance of analysis of the full set of 13 counties. This document is one of a series of documents to review various measures and indices relating to resilience.

# Resilience

## Absorptive capacity

### Community group participation

```{r}

grps <- dat %>%
  select(grp_water:grp_animalherding)

map(grps, frq)

```


```{r}
frq(dat$grp_sum)
```

```{r}
ggplot(dat, aes(grp_sum)) +
  geom_bar(fill=light_blue,
           width=.5)
```

#### rank frequencies

```{r}
names(grps)

grps_temp <- svyrdat %>%
  summarize(grp_water = survey_mean(grp_water, na.rm=T),
            grp_land  = survey_mean(grp_land, na.rm=T),
            grp_resource  = survey_mean(grp_resource, na.rm=T),
            grp_credit  = survey_mean(grp_credit, na.rm=T),
            grp_savings = survey_mean(grp_savings, na.rm=T),
            grp_help  = survey_mean(grp_help, na.rm=T),
            grp_relig  = survey_mean(grp_relig, na.rm=T),
            grp_mother  = survey_mean(grp_mother, na.rm=T),
            grp_women = survey_mean(grp_women, na.rm=T),
            grp_youth = survey_mean(grp_youth, na.rm=T),
            grp_sports  = survey_mean(grp_sports, na.rm=T),
            grp_disaster  = survey_mean(grp_disaster, na.rm=T),
            grp_raiding = survey_mean(grp_raiding, na.rm=T),
            grp_herding  = survey_mean(grp_herding, na.rm=T),
            grp_cattleprotect = survey_mean(grp_cattleprotect, na.rm=T),
            grp_animalherding  = survey_mean(grp_animalherding, na.rm=T))

grps_temp

```

```{r}

grps_mn <- grps_temp %>%
  select(!contains("se")) %>%
  melt() %>%
  mutate(group = grp_labs) %>%
  select(1,3,2)
         

grps_se <- grps_temp %>%
  select(contains("se")) %>%
  melt() %>%
  rename(se=value)

grps_se

grps_sum <- grps_mn %>%
  cbind(grps_se[,2]) %>%
  rename(percent=value,
         se = 4) %>%
  mutate(lower=percent-1.96*se,
         upper=percent+1.96*se,
         item=grp_items) %>%
  arrange(desc(percent)) %>%
  relocate(item, .after=variable)

grps_sum

write_csv(grps_sum, here("output/tables/resilience/groups weighted.csv"))

grps_sum_gt <- grps_sum %>%
  gt() %>%
  fmt_percent(4:7, decimals=1)

grps_sum_gt

gtsave(grps_sum_gt, here("output/tables/resilience/groups weighted.rtf"))

```

#### IRT

```{r}

#library(ltm)

ltm_grps <- ltm(grps ~ z1)

ltm_grps
#summary(l1)

```

Credit, savings, and self-help groups have the highest 'difficulty'

Cattle protection and herding have the highest discrimination


```{r}
plot(ltm_grps, type="ICC")
```

```{r}
plot(ltm_grps, type="IIC")
```

```{r}
plot(ltm_grps, type="IIC",
     items=0)
```

```{r}

ltm_grps_out <- coef(ltm_grps) %>%
  as.data.frame() %>%
  rownames_to_column("variable") %>%
  mutate(item=grp_items) %>%
  select(1,4, difficulty=2,discrimination=3)

ltm_grps_out

write_csv(ltm_grps_out, here("output/tables/resilience/grps irt.csv"))

ltm_grps_gt <- ltm_grps_out %>%
  gt() %>%
  fmt_number(3:4,
             decimals=2)

ltm_grps_gt

gtsave(ltm_grps_gt, here("output/tables/resilience/grps irt.rtf"))

```

#### Factor analysis 

```{r}

fa.parallel(grps,
            cor="tet")

# 5 factors, 3 components

```

```{r}

fa_grps_5 <- fa(grps,
                 nfactors=5,
                 scores="tenBerge",
                 fm="ml",
                 cor="tet")


fa_grps_5

```

ML3: cattle herding, cattle protection, cattle raiding, animal herding, land

ML4: women group, mothers group, religious group

ML2: savings group, credit group

ML1: sports, youth 

ML5: natural resource management, self-help, water, land management

Captures 75 percent of the variance of all items

Fit statistics good but not great (Tucker-Lewis 86 percent, RMSEA .14)

```{r}

fa_grps_ldngs <- fa_grps_5$loadings %>%
  unclass() %>%
  as.data.frame() %>%
  rownames_to_column("item") %>%
  mutate(group=grp_labs,
         difficulty=ltm_grps_out$difficulty,
         discrimination=ltm_grps_out$discrimination) %>%
  relocate(group, .after=item)

fa_grps_ldngs

write_csv(fa_grps_ldngs, here("output/tables/resilience/groups loadings.csv"))

fa_grps_gt <- fa_grps_ldngs %>%
  gt() %>%
  fmt_number(3:9, decimals=2)

fa_grps_gt

gtsave(fa_grps_gt, here("output/tables/resilience/groups loadings.rtf"))
```


```{r}
fa_grps_5_scrs <- fa_grps_5$scores %>%
  as.data.frame()

dat <- dat %>%
  mutate(grp_fac_cattle = fa_grps_5_scrs$ML3,
         grp_fac_women = fa_grps_5_scrs$ML4,
         grp_fac_finance = fa_grps_5_scrs$ML2,
         grp_fac_sports = fa_grps_5_scrs$ML1,
         grp_fac_nature = fa_grps_5_scrs$ML5)

grp_facs <- dat %>%
  select(grp_fac_cattle:grp_fac_nature)

fa.parallel(grp_facs)

```

Three factors and one component. We are interested in a single broad measure of group membership, so we will extract a single factor. 

```{r}
fa_grp_fac <-fa(grp_facs,
                 scores="tenBerge",
                 fm="ml")

fa_grp_fac

```

```{r}

fa_grp_fac_ldngs <- fa_grp_fac$loadings %>%
  unclass() %>%
  as.data.frame() %>%
  rownames_to_column("item") %>%
  mutate(description=c("Cattle/herding","Women/Mothers","Savings/Credit","Sports/Youth","Natural resource management")) %>%
  relocate(description, .after=item)

fa_grp_fac_ldngs

write_csv(fa_grp_fac_ldngs, here("output/tables/resilience/group facs loadings.csv"))

fa_grp_fac_gt <- fa_grp_fac_ldngs %>%
  gt() %>%
  fmt_number(3, decimals=2)

fa_grp_fac_gt

gtsave(fa_grp_fac_gt, here("output/tables/resilience/group facs loadings.rtf"))
```


```{r}
fa_grp_fac_scrs <- fa_grp_fac$scores %>%
  unlist() %>%
  as.data.frame()

dat <- dat %>%
  mutate(grp_latent = fa_grp_fac_scrs$ML1,
         grp_latent_resc = scales::rescale(grp_latent, c(0,100)))
#class(dat$grp_latent_resc)
```

```{r}
grp_latent_mn <- svyrdat %>%
  summarize(grp = survey_mean(grp_latent_resc, na.rm=T)) %>%
  mutate(lower=grp-1.96*grp_se,
         upper=grp+1.96*grp_se)

grp_latent_mn

```

### Remittances

```{r}
remit_mn <- svyrdat %>%
  summarize(remit = survey_mean(access_remittances, na.rm=T)) %>%
  mutate(lower=remit-1.96*remit_se,
         upper=remit+1.96*remit_se)

remit_mn
```



```{r}
prin_grp_facs <- principal(grp_facs)
prin_grp_facs
```
```{r}
prin_grp_facs_scrs <- data.frame(prin_grp_facs$scores)
describe(prin_grp_facs_scrs)
```

```{r}
dat <- dat %>%
  mutate(grp_facs_comp=prin_grp_facs_scrs$PC1)

ggplot(dat, aes(grp_facs_comp)) + 
  geom_density()
```


```{r}
prin_grps <- principal(grps,
                       cor="tet")
prin_grps
```

```{r}
prin_grps_scrs <- data.frame(prin_grps$scores)
describe(prin_grps_scrs)
```

```{r}
dat <- dat %>%
  mutate(grp_participate_comp=prin_grps_scrs$PC1)

ggplot(dat, aes(grp_participate_comp)) + 
  geom_density()
```
```{r}
g1 <- svyglm(fies_raw ~ grp_participate_comp + shock_exposure_index + 
               as.factor(county),
             design=svydat)

summary(g1)
```
```{r}
ggplot(dat, aes(grp_sum, grp_participate_comp)) +
  geom_point(color=light_blue) + 
  stat_smooth() +
  scale_x_continuous(breaks=1:16)
```


### Bonding social capital

```{r}
frq(dat$bonding_capital_raw)
```

```{r}
bond <- dat %>%
  select(q_490,
         rc_q_491,
         q_494,
         rc_q_495)

map(bond, frq)
```

```{r}

irt_bond <- ltm(bond ~ z1)

irt_bond

#summary(l1)

```

```{r}
plot(irt_bond, type="ICC")
```

```{r}
plot(irt_bond, type="IIC")
```

```{r}
plot(irt_bond, 
     type="IIC",
     items=0)
```

```{r}

fa.parallel(bond,
            cor="tet")

# 2 factors, 1 components

fa_bond_2 <- fa(bond,
                nfactors=2,
                scores="tenBerge",
                fm="ml",
                cor="tet")


fa_bond_2

```

```{r}

fa_bond_1 <- fa(bond,
                nfactors=1,
                #scores="tenBerge",
                fm="ml",
                cor="tet")


fa_bond_1

```



```{r}
prin_bond <- principal(bond,
                       cor="tet")
prin_bond
```
```{r}
frq(dat$bonding_capital_raw)

prin_bond_scrs <- prin_bond$scores %>%
  as.data.frame()

dat <- dat %>%
  mutate(bonding_capital_comp = prin_bond_scrs$PC1)

describe(dat$bonding_capital_comp)

```

```{r}
ggplot(dat, aes(bonding_capital_comp)) + 
  geom_density()
```

```{r}
frq(dat$bonding_capital_comp)
```


```{r}
ggplot(dat, aes(bonding_capital_raw, bonding_capital_comp)) + 
  geom_point(color=light_blue) + 
  stat_smooth()
```


```{r}
ggplot(dat, aes(bonding_capital_raw)) + 
  geom_bar()
```

```{r}
g2 <- svyglm(fies_raw ~ grp_participate_comp + bonding_capital_comp + shock_exposure_index + 
               as.factor(county),
             design=svydat)

summary(g2)
```

### Access to savings / remittances

```{r}
library(sjPlot)

frq(dat$q_401_a)
frq(dat$q_401_a_bin)

inc <- dat %>%
  select(q_401_a_bin,
         q_401_b_bin,
         q_401_c_bin,
         q_401_d_bin,
         q_401_e_bin,
         q_401_f_bin,
         q_401_g_bin,
         q_401_h_bin,
         q_401_i_bin,
         q_401_j_bin,
         q_401_k_bin,
         q_401_l_bin,
         q_401_m_bin,
         q_401_n_bin,
         q_401_o_bin,
         q_401_p_bin,
         q_401_q_bin,
         q_401_r_bin,
         q_401_s_bin,
         q_401_t_bin)

map(inc, frq)
#sjt.stackfrq(inc)

```

```{r}
fa.parallel(inc,
            cor="tet")
```
7 factors, 5 components

#### 7 factors

```{r}
fa_inc_7 <- fa(inc,
               nfactors=7,
               scores="tenBerge",
               fm="ml",
               cor="tet")
fa_inc_7
```


```{r}
fa_inc_7_ldngs <- as.matrix(fa_inc_7$loadings) %>%
  unclass() %>%
  as.data.frame() %>%
  rownames_to_column("varname") %>%
  select(1:8) %>%
  left_join(inc_key) %>%
  select(9,11, 2:8) 

fa_inc_7_ldngs

```

ML4: d/c/b sheep/goat/cattle production/sales

ML5: petty trade / other employment

ML1: Ag wage labor

ML3: Wage labor

ML6: property rental / remittances / salaried work

ML2: Farmer

ML7: inheritance / safety net


```{r}
fa_inc_7_scores <- data.frame(fa_inc_7$scores)

dat <- dat %>%
  mutate(inc_fac_livestocksales=fa_inc_7_scores$ML4,
         inc_fac_pettytrade=fa_inc_7_scores$ML5,
         inc_fac_agwage=fa_inc_7_scores$ML1,
         inc_fac_wage=fa_inc_7_scores$ML3,
         inc_fac_proprent=fa_inc_7_scores$ML6,
         inc_fac_farmer=fa_inc_7_scores$ML2,
         inc_fac_safetynet=fa_inc_7_scores$ML7)
```


```{r}
fa_inc_7_ldngsL <- fa_inc_7_ldngs %>% 
  pivot_longer(cols=3:9,
               names_to="factor",
               values_to="loading") %>%
  #arrange(factor) %>%
  mutate(significance=ifelse(loading>.3999, "Significant loading", ""))

#fa_inc_7_ldngsL

```


```{r fig.width=8.4}
ggplot(fa_inc_7_ldngsL, aes(x=loading, y=reorder(inc_code, desc(inc_code)), color=significance)) + 
  #geom_bar() + 
  geom_point() +
  scale_color_manual(values=c("grey60", medium_blue)) +
  scale_x_continuous(limits=c(.4,1),
                     breaks=c(.4,.8)) +
  scale_y_discrete(breaks=1:20,
                     labels=inc_labs) +
  facet_wrap(~factor, nrow=1) +
  faceted +
  theme(legend.position="none") +
  labs(x="",
       y="")
```
```{r}
ggsave(here("output/viz/fa inc 7 loadings.png"),
       device="png",
       type="cairo",
       height=5,
       width=10)
```

```{r}
g3 <- svyglm(fies_raw ~ grp_facs_comp + bonding_capital_comp + q_401_q_bin + q_401_r_bin + 
               shock_exposure_index + 
               as.factor(county),
             design=svydat)

summary(g3)
```

#### 5 factors

```{r}
fa_inc_5 <- fa(inc,
               nfactors=5,
               scores="tenBerge",
               fm="ml",
               cor="tet")
fa_inc_5
```

```{r}
fa_inc_5_ldngs <- as.matrix(fa_inc_5$loadings) %>%
  unclass() %>%
  as.data.frame() %>%
  rownames_to_column("varname") %>%
  select(1:6) %>%
  left_join(inc_key) %>%
  select(1,7:9, everything()) %>%
  pivot_longer(cols=5:9,
               names_to="factor",
               values_to="loading") %>%
  #arrange(factor) %>%
  mutate(significance=ifelse(loading>.3999, "Significant loading", ""))

fa_inc_5_ldngs

```

```{r fig.width=8.4}
ggplot(fa_inc_5_ldngs, aes(x=loading, y=reorder(inc_code, desc(inc_code)), color=significance)) + 
  #geom_bar() + 
  geom_point() +
  scale_color_manual(values=c("grey60", medium_blue)) +
  scale_x_continuous(breaks=seq(0,1,.5)) +
  scale_y_discrete(breaks=1:20,
                     labels=inc_labs) +
  facet_wrap(~factor, nrow=1) +
  faceted +
  theme(legend.position="none") +
  labs(x="",
       y="")
```




### Inc factors, by ranking

```{r}
library(sjPlot)

frq(dat$q_402_a)
frq(dat$q_402_a_bin)

inc_rank <- dat %>%
  select(q_402_a,
         q_402_b,
         q_402_c,
         q_402_d,
         q_402_e,
         q_402_f,
         q_402_g,
         q_402_h,
         q_402_i,
         q_402_j,
         q_402_k,
         q_402_l,
         q_402_m,
         q_402_n,
         q_402_o,
         q_402_p,
         q_402_q,
         q_402_r,
         q_402_s,
         q_402_t)

map(inc_rank, frq)
#sjt.stackfrq(inc)

```

```{r}
inc_rank[is.na(inc_rank)] <- 0

# inc_rank[inc_rank==3] <- 6
# 
# inc_rank[inc_rank==2] <- 4
# 
# inc_rank[is.na(inc_rank)] <- 0

```



```{r}
inc_labs
inc_rank2 <- dat %>%
  mutate(farm_rank = ifelse(is.na(q_402_a), 0,
                            ifelse(q_402_a!=0, 4-q_402_a, 0)),
         cattle_rank = ifelse(is.na(q_402_b), 0,
                            ifelse(q_402_b!=0, 4-q_402_b, 0)),
         goat_rank = ifelse(is.na(q_402_c), 0,
                            ifelse(q_402_c!=0, 4-q_402_c, 0)),
         sheep_rank = ifelse(is.na(q_402_d), 0,
                            ifelse(q_402_d!=0, 4-q_402_d, 0)),
         fish_rank = ifelse(is.na(q_402_e), 0,
                            ifelse(q_402_e!=0, 4-q_402_e, 0)),
         agwage_in_rank = ifelse(is.na(q_402_f), 0,
                             ifelse(q_402_f!=0, 4-q_402_f, 0)),
         agwage_out_rank = ifelse(is.na(q_402_g), 0,
                            ifelse(q_402_g!=0, 4-q_402_g, 0)),
         wage_in_rank = ifelse(is.na(q_402_h), 0,
                            ifelse(q_402_h!=0, 4-q_402_h, 0)),
         wage_out_rank = ifelse(is.na(q_402_i), 0,
                            ifelse(q_402_i!=0, 4-q_402_i, 0)),
         salary_rank = ifelse(is.na(q_402_j), 0,
                            ifelse(q_402_j!=0, 4-q_402_j, 0)),
         bush_rank = ifelse(is.na(q_402_k), 0,
                            ifelse(q_402_k!=0, 4-q_402_k, 0)),
         honey_rank = ifelse(is.na(q_402_l), 0,
                            ifelse(q_402_l!=0, 4-q_402_l, 0)),
         petty_other_rank = ifelse(is.na(q_402_m), 0,
                            ifelse(q_402_m!=0, 4-q_402_m, 0)),
         petty_own_rank = ifelse(is.na(q_402_n), 0,
                            ifelse(q_402_n!=0, 4-q_402_n, 0)),
         other_ag_rank = ifelse(is.na(q_402_o), 0,
                            ifelse(q_402_o!=0, 4-q_402_o, 0)),
         other_nonag_rank = ifelse(is.na(q_402_p), 0,
                            ifelse(q_402_p!=0, 4-q_402_p, 0)),
         rent_rank = ifelse(is.na(q_402_q), 0,
                            ifelse(q_402_q!=0, 4-q_402_q, 0)),
         remit_rank = ifelse(is.na(q_402_r), 0,
                            ifelse(q_402_r!=0, 4-q_402_r, 0)),
         gift_rank = ifelse(is.na(q_402_s), 0,
                            ifelse(q_402_s!=0, 4-q_402_s, 0)),
         safety_rank = ifelse(is.na(q_402_t), 0,
                            ifelse(q_402_t!=0, 4-q_402_t, 0)),
         ) %>%
  select(farm_rank:safety_rank)
         
lapply(inc_rank2, mean)         




```

```{r}
fa.parallel(inc_rank2,
            cor="poly")
```
8 factors, 5 components

```{r}
fa_incrank2_8 <- fa(inc_rank2,
                    cor="poly",
                    nfactors=8,
                    scores="tenBerge",
                    fm="ml")

fa_incrank2_8

```

ML6: goats, sheep, cattle

ML7: other ag, other non ag, petty trade other

ML5: rent, remittances, salary

ML4: ag wage in village, ag wage out of village

ML1: wage out of village

ML3: farmer

ML8: honey, gift, fish

ML2: petty trade own goods

```{r}
fa_incrank2_8_scrs <- fa_incrank2_8$scores %>%
  unlist() %>%
  as.data.frame()


dat <- dat %>%
  mutate(incrank_fac_livestock = fa_incrank2_8_scrs$ML6,
         incrank_fac_selfemployed = fa_incrank2_8_scrs$ML7,
         incrank_fac_rentremitsal = fa_incrank2_8_scrs$ML5,
         incrank_fac_agwage = fa_incrank2_8_scrs$ML4,
         incrank_fac_wageout = fa_incrank2_8_scrs$ML1,
         incrank_fac_farm = fa_incrank2_8_scrs$ML3,
         incrank_fac_honeygiftfish = fa_incrank2_8_scrs$ML8,
         incrank_fac_pettytradeown = fa_incrank2_8_scrs$ML2)


```

```{r}
l1 <- svyglm(fies_raw ~ 
               incrank_fac_livestock + 
               incrank_fac_selfemployed +
               incrank_fac_rentremitsal +
               incrank_fac_agwage +
               incrank_fac_wageout +
               incrank_fac_farm + 
               incrank_fac_honeygiftfish +
               incrank_fac_pettytradeown + 
               household_members + as.factor(hh_head_sex) + urban + as.factor(county),
             design=svydat)

summary(l1)

```



### Shock preparedness and mitigation

Nothing from the TANGO manual, but from our instrument we have early warning systems and emergency action plans

#### Early warning system

```{r}
ews <- dat %>%
  select(warn_hazards:warn_foodprices)

map(ews, frq)

```

##### rank frequencies

```{r}
names(ews)

ews_temp <- svyrdat %>%
  summarize(warn_hazards = survey_mean(warn_hazards, na.rm=T),
            warn_weather = survey_mean(warn_weather, na.rm=T),
            warn_rainfall = survey_mean(warn_rainfall, na.rm=T),
            warn_waterprices = survey_mean(warn_water, na.rm=T),
            warn_animalhealth = survey_mean(warn_livestock, na.rm=T),
            warn_crophealth = survey_mean(warn_crops, na.rm=T),
            warn_livestockprices = survey_mean(warn_animalprices, na.rm=T),
            warn_animalproductprices = survey_mean(warn_prices, na.rm=T),
            warn_grazing = survey_mean(warn_grazing, na.rm=T),
            warn_conflict = survey_mean(warn_conflict, na.rm=T),
            warn_foodprices = survey_mean(warn_foodprices, na.rm=T))
            
grps_temp

```

```{r}

ews_mn <- ews_temp %>%
  select(!contains("se")) %>%
  melt() %>%
  mutate(ews = ews_labs) %>%
  select(1,3,2)
         

ews_se <- ews_temp %>%
  select(contains("se")) %>%
  melt() %>%
  rename(se=value)

ews_se

ews_sum <- ews_mn %>%
  cbind(ews_se[,2]) %>%
  rename(percent=value,
         se = 4) %>%
  mutate(lower=percent-1.96*se,
         upper=percent+1.96*se) %>%
  arrange(desc(percent))

ews_sum

write_csv(ews_sum, here("output/tables/resilience/ews weighted.csv"))

ews_sum_gt <- ews_sum %>%
  gt() %>%
  fmt_percent(3:6, decimals=1)

ews_sum_gt

gtsave(ews_sum_gt, here("output/tables/resilience/ews weighted.rtf"))

```


##### IRT

```{r}
ltm_ews <- ltm(ews ~ z1)
ltm_ews
```

Price warnings least common; water, crops, and livestock most common

animal prices, general prices, and grazing highest discrimination

```{r}

ltm_ews_out <- coef(ltm_ews) %>%
  as.data.frame() %>%
  rownames_to_column("variable") %>%
  mutate(item=ews_labs) %>%
  select(1,4, difficulty=2,discrimination=3)

ltm_ews_out

write_csv(ltm_ews_out, here("output/tables/resilience/ews irt.csv"))

ltm_ews_gt <- ltm_ews_out %>%
  gt() %>%
  fmt_number(3:4,
             decimals=2)

ltm_ews_gt

gtsave(ltm_ews_gt, here("output/tables/resilience/ews irt.rtf"))

```

##### Factor analysis

```{r}
fa.parallel(ews,
            cor="tet")
```
4 factors, 2 components

```{r}
fa_ews_4 <- fa(ews,
               nfactors=4,
               scores="tenBerge",
               fm="ml",
               cor="tet")
fa_ews_4
```


```{r}
fa_ews_4_ldngs <- as.matrix(fa_ews_4$loadings) %>%
  unclass() %>%
  as.data.frame() %>%
  mutate(description=ews_labs,
         difficulty=ltm_ews_out$difficulty,
         discrimination=ltm_ews_out$discrimination) %>%
  rownames_to_column("variable") %>%
  relocate(description,.after=variable)

fa_ews_4_ldngs

write_csv(fa_ews_4_ldngs, here("output/tables/resilience/ews loadings.csv"))

fa_ews_gt <- fa_ews_4_ldngs %>%
  gt() %>%
  fmt_number(3:8, decimals=2)

fa_ews_gt

gtsave(fa_ews_gt, here("output/tables/resilience/ews loadings.rtf"))

```

ML3: prices, animal prices, food prices

ML4: weather, hazards, rain

ML1: livestock, crops

ML2: conflict


```{r}
fa_ews_4_scores <- data.frame(fa_ews_4$scores)

dat <- dat %>%
  mutate(ews_fac_prices = fa_ews_4_scores$ML3,
         ews_fac_weather = fa_ews_4_scores$ML4,
         ews_fac_farming = fa_ews_4_scores$ML1,
         ews_fac_conflict = fa_ews_4_scores$ML2)

```


```{r}
fa_ews_4_ldngsL <- fa_ews_4_ldngs %>% 
  pivot_longer(cols=2:5,
               names_to="factor",
               values_to="loading") %>%
  #arrange(factor) %>%
  mutate(significance=ifelse(loading>.3999, "Significant loading", ""))

fa_ews_4_ldngsL

```


```{r fig.width=8.4}
ggplot(fa_ews_4_ldngsL, aes(x=loading, y=varname, color=significance)) + 
  #geom_bar() + 
  geom_point() +
  scale_color_manual(values=c("grey60", medium_blue)) +
  scale_x_continuous(limits=c(.4,1),
                     breaks=c(.4,.8)) +
  scale_y_discrete(breaks=1:20,
                     labels=inc_labs) +
  facet_wrap(~factor, nrow=1) +
  faceted +
  theme(legend.position="none") +
  labs(x="",
       y="")
```

```{r}
ews_facs <- dat %>%
  select(ews_fac_prices:ews_fac_conflict)

fa.parallel(ews_facs)

```

2 factors, 1 component

```{r}
fa_ews_facs <- fa(ews_facs,
                  scores="tenBerge",
                  fm="ml")

fa_ews_facs
```

```{r}
fa_ews_facs_ldngs <- as.matrix(fa_ews_facs$loadings) %>%
  unclass() %>%
  as.data.frame() %>%
  mutate(description=c("Animal product/livestock/food prices",
                       "Natural hazards/weather",
                       "Animal/crop health",
                       "Conflict")) %>%
  rownames_to_column("factor") %>%
  relocate(description,.after=factor)

fa_ews_facs_ldngs

write_csv(fa_ews_facs_ldngs, here("output/tables/resilience/ews facs loadings.csv"))

fa_ews_facs_gt <- fa_ews_facs_ldngs %>%
  gt() %>%
  fmt_number(3, decimals=2)

fa_ews_facs_gt

gtsave(fa_ews_facs_gt, here("output/tables/resilience/ews facs loadings.rtf"))

```


```{r}
fa_ews_facs_scrs <- fa_ews_facs$scores %>%
  unlist() %>%
  as.data.frame()

dat <- dat %>%
  mutate(ews_latent = fa_ews_facs_scrs$ML1,
         ews_latent_resc = scales::rescale(ews_latent, c(0,100)))

ggplot(dat, aes(ews_latent)) + 
  geom_density()

```

```{r}
ews_latent_mn <- svyrdat %>%
  summarize(ews = survey_mean(grp_latent_resc, na.rm=T)) %>%
  mutate(lower=ews-1.96*ews_se,
         upper=ews+1.96*ews_se)

ews_latent_mn

```



```{r}
ews_prin <- principal(ews,
                      cor="tet")
ews_prin
```

```{r}

ews_prin_scrs <- ews_prin$scores %>%
  as.data.frame()

dat <- dat %>%
  mutate(ews_comp=ews_prin_scrs$PC1)

describe(dat$ews_comp)
```

```{r}
ews_prin$weights
```
```{r}
ggplot(dat, aes(ews_comp)) +
  geom_density()
```


```{r}
ggplot(dat, aes(x=ews_comp)) + 
  stat_smooth(aes(y=warn_animalprices), color=light_blue, se=F) + 
  stat_smooth(aes(y=warn_prices), color=medium_blue, se=F) + 
  stat_smooth(aes(y=warn_grazing), color=usaid_red, se=F) +
  stat_smooth(aes(y=warn_livestock), color=dark_red, se=F) + 
  stat_smooth(aes(y=warn_crops), color=rich_black, se=F) + 
  stat_smooth(aes(y=warn_hazards), color=light_grey, se=F) 
  #geom_point(aes(y=warn_animalprices), color=light_blue) +
  #geom_point(aes(y=warn_prices), color=medium_blue)

```
```{r}
ggplot(dat, aes(y=ews_comp)) + 
  geom_point(aes(x=warn_sum), color=dark_grey, size=.6) + 
  stat_smooth(aes(x=warn_sum), color=dark_grey, se=F) +
  scale_x_continuous(breaks=1:11)

```

#### Emergency action plans

```{r}
frq(dat$q_612)
```

##### frequencies

```{r}
names(grps)

emerg_temp <- svyrdat %>%
  summarize(q610 = survey_mean(emerg1, na.rm=T),
            q611 = survey_mean(emerg2, na.rm=T),
            q612 = survey_mean(emerg3, na.rm=T),
            q501l = survey_mean(emerg4, na.rm=T))

emerg_temp

```

```{r}

emerg_mn <- emerg_temp %>%
  select(!contains("se")) %>%
  melt() %>%
  mutate(description=emerg_labs) %>%
  select(1,3,2)

emerg_mn         

emerg_se <- emerg_temp %>%
  select(contains("se")) %>%
  melt() %>%
  rename(se=value)

emerg_se

emerg_sum <- emerg_mn %>%
  cbind(emerg_se[,2]) %>%
  rename(percent=value,
         se = 4) %>%
  mutate(lower=percent-1.96*se,
         upper=percent+1.96*se) %>%
  arrange(desc(percent)) %>%
  relocate(description, .after=variable)

emerg_sum

write_csv(emerg_sum, here("output/tables/resilience/emergency weighted.csv"))

emerg_sum_gt <- emerg_sum %>%
  gt() %>%
  fmt_percent(3:6, decimals=1)

emerg_sum_gt

gtsave(emerg_sum_gt, here("output/tables/resilience/emergency weighted.rtf"))

```



```{r}
emerg <- dat %>%
  select(emerg1:emerg4)
head(emerg)
map(emerg, frq)
```
##### IRT

```{r}
ltm_emerg <- ltm(emerg ~ z1)
ltm_emerg
```
```{r}

ltm_emerg_out <- coef(ltm_emerg) %>%
  as.data.frame() %>%
  rownames_to_column("variable") %>%
  mutate(description=emerg_labs) %>%
  select(1,4, difficulty=2,discrimination=3)

ltm_emerg_out

write_csv(ltm_emerg_out, here("output/tables/resilience/emerg irt.csv"))

ltm_emerg_gt <- ltm_emerg_out %>%
  gt() %>%
  fmt_number(3:4,
             decimals=2)

ltm_emerg_gt

gtsave(ltm_emerg_gt, here("output/tables/resilience/emerg irt.rtf"))

```


```{r}
plot(ltm_emerg, type="ICC")
```

```{r}
plot(ltm_emerg, type="IIC")
```

```{r}
plot(ltm_emerg, 
     type="IIC",
     items=0)
```

```{r}
ltm_emerg2 <- ltm(emerg[,1:3] ~ z1)
ltm_emerg2
```

```{r}
plot(ltm_emerg2, type="ICC")
```
```{r}
plot(ltm_emerg2, type="IIC")
```

```{r}
plot(ltm_emerg2, 
     type="IIC",
     items=0)
```

##### Factor analysis

```{r}
fa.parallel(emerg,
            cor="tet")
```
2 factors, 1 component

```{r}
fa_emerg <- fa(emerg,
               scores="tenBerge",
               fm="ML")
fa_emerg

```

```{r}

fa_emerg_ldngs <- fa_emerg$loadings %>%
  unclass() %>%
  as.data.frame() %>%
  rownames_to_column("item") %>%
  mutate(description=emerg_labs,
         difficulty=ltm_emerg_out$difficulty,
         discrimination=ltm_emerg_out$discrimination) %>%
  relocate(description, .after=item)

fa_emerg_ldngs

write_csv(fa_emerg_ldngs, here("output/tables/resilience/emerg loadings.csv"))

fa_emerg_gt <- fa_emerg_ldngs %>%
  gt() %>%
  fmt_number(3:5, decimals=2)

fa_emerg_gt

gtsave(fa_emerg_gt, here("output/tables/resilience/emerg loadings.rtf"))
```


```{r}
fa_emerg_scrs <- fa_emerg$scores %>%
  unlist() %>%
  as.data.frame()

dat <- dat %>%
  mutate(emerg_fac = fa_emerg_scrs$ML1,
         emerg_fac_resc = scales::rescale(emerg_fac, c(0,100)))

```

```{r}
emerg_fac_mn <- svyrdat %>%
  summarize(emerg = survey_mean(emerg_fac_resc, na.rm=T)) %>%
  mutate(lower=emerg-1.96*emerg_se,
         upper=emerg+1.96*emerg_se)

emerg_fac_mn

```

## Donor activity

```{r}
donor_mn <- svyrdat %>%
  summarize(donor = survey_mean(donor_act, na.rm=T)) %>%
  mutate(lower=donor-1.96*donor_se,
         upper=donor+1.96*donor_se)

donor_mn

```

```{r}
prin_emerg <- principal(emerg,
                        cor="tet")
prin_emerg
```

```{r}
weights(prin_emerg)
```
```{r}

prin_emerg_scrs <- prin_emerg$scores %>%
  as.data.frame()

dat <- dat %>%
  mutate(emerg_comp = prin_emerg_scrs$PC1)

describe(dat$emerg_comp)

ggplot(dat, aes(emerg_comp)) + 
  geom_density()
```



```{r}
prin_emerg2 <- principal(emerg[,1:3])
prin_emerg2
```


```{r}

prin_emerg2_scrs <- prin_emerg2$scores %>%
  as.data.frame()

dat <- dat %>%
  mutate(emerg_comp2 = prin_emerg2_scrs$PC1)

describe(dat$emerg_comp2)

ggplot(dat, aes(emerg_comp2)) + 
  geom_density()
```

```{r}
ggplot(dat, aes(emerg_comp, emerg_sum)) + 
  geom_point(color="blue") + 
  stat_smooth(method="lm")
```

### Humanitarian assistance 

```{r}
frq(dat$donor_act)
```

### Modeling components of absorptive capacity

```{r}

abs1 <- svyglm(fies_raw ~ grp_facs_comp + bonding_capital_raw + q_401_r_bin + 
                 ews_comp + emerg_sum + donor_act +
               shock_facs_comp,
             design=svydat)

summary(abs1)

```

```{r}

abs2 <- svyglm(fies_raw ~ grp_facs_comp + bonding_capital_raw + q_401_r_bin + 
               ews_comp + emerg_sum + donor_act +
               shock_facs_comp + urban + as.factor(county),
             design=svydat)

summary(abs2)

```
```{r}
tidy_out(abs2, letters[1:21])

abs2_t <- tidy(abs2) %>%
    mutate(lower = estimate - 1.96*std.error,
           upper = estimate + 1.96*std.error,
           color=case_when(lower > 0 ~ "#002F6C",
                           upper < 0 ~ "#BA0C2F",
                           TRUE ~ "#8C8985")) %>%
  .[1:9,] %>%
  filter(term!="(Intercept)") %>%
  mutate(term2 = c("Group participation (-1 to 3)",
                   "Bonding social capital (0-4)",
                   "Access to remittances",
                   "Early warning systems (-1 to 2)",
                   "Emergency planning (0-3)",
                   "Humanitarian assistance",
                   "Shock exposure (-1 to 3)",
                   "Urban locality")) %>%
  select(term, term2, everything())

abs2_t

```

```{r}
ggplot(abs2_t, aes(x=estimate, y=fct_reorder(term2, -estimate)), color = color, fill = color) +
    geom_vline(xintercept=0, color="darkgrey", size=1.2) +
    geom_errorbarh(aes(xmin=lower, xmax=upper), color=abs2_t$color, height=0, size=1.2, alpha = 0.7) +
    geom_label(aes(label=round(estimate,2)),color = abs2_t$color, size=4.5) +
    scale_x_continuous(breaks=seq(-1,1,.5),
                       limits=c(-1,1)) +
#                       labels = scales::percent_format(accuracy=1)) +
    labs(x = "", y = "",
         title="Absorptive capacity measures\nand food insecurity",
         caption="Each coefficient shows the effect on food insecurity,\nfor every one-unit change in the predictor variable")

ggsave(here("output/viz/fies absorptive regplot.png"),
            device="png",
            type="cairo",
            height=4,
            width=7)
```


```{r}

abs3 <- svyglm(shock_facs_comp ~ grp_facs_comp + bonding_capital_raw + q_401_r_bin + 
               ews_comp + emerg_sum + donor_act +
               urban + as.factor(county),
               design=svydat)

summary(abs3)

```



### Absorptive capacity factor analysis

```{r}
absorp <- dat %>%
  select(grp_facs_comp,
         bonding_capital_raw,
         access_remittances=q_401_r_bin,
         ews_comp,
         emerg_sum,
         donor_act)

fa.parallel(absorp,
            cor="mixed")
```
3 factors, 2 components

```{r}
fa_absorp_3 <- fa(absorp,
                  nfactors=3,
                  scores="tenBerge",
                  fm="ml",
                  cor="mixed")

fa_absorp_3
```
ML2: group participation, emergency planning, early warning system

ML1: bonding social capital

ML3: donor activity, bonding capital

46 percent of variance explained. No fit statistics. 

```{r}
prin_absorp <- principal(absorp,
                         cor="mixed")
prin_absorp
```

```{r}
prin_absorp_scrs <- prin_absorp$scores %>%
  as.data.frame()

dat <- dat %>% 
  mutate(absorb_comp = prin_absorp_scrs$PC1)

```


```{r}
fa_absorp_3_scrs <- fa_absorp_3$scores %>%
  as.data.frame() %>%
  set_names(nm=c("Group_participation", "Emergency_planning", "Donor_activity"))

dat <- dat %>%
  mutate(Group_participation=fa_absorp_3_scrs$Group_participation,
         Emergency_planning = fa_absorp_3_scrs$Emergency_planning,
         Donor_activity = fa_absorp_3_scrs$Donor_activity)

```

#### Absorptive factors factor analysis

##### first try

```{r}
absorp_facs <- dat %>%
  select(Group_participation,
         Emergency_planning,
         Donor_activity)

fa.parallel(absorp_facs)
```

1 factor, 1 component

```{r}
fac_absorp_facs <- fa(absorp_facs,
                      #scores="tenBerg",
                      fm="ml")

fac_absorp_facs

```
45 percent of variance explained. No fit statistics. 

```{r}
prin_absorp_facs <- principal(absorp_facs)
prin_absorp_facs
```

62 percent of variance explained


```{r}
prin_absorp_facs_scrs <- prin_absorp_facs$scores %>%
  as.data.frame()

dat <- dat %>%
  mutate(Absorptive_Capacity = prin_absorp_facs_scrs$PC1)

#describe(dat$Absorptive_Capacity)

quantile(dat$Absorptive_Capacity, probs=seq(0,1,.25), na.rm=T)
quantile(dat$absorb_comp, probs=seq(0,1,.25), na.rm=T)

```

```{r}
dat <- dat %>%
  mutate(#Absorptive_Type = case_when(Absorptive_Capacity < -.79 ~ "Low",
          #                           Absorptive_Capacity > .61 ~ "High",
           #                          TRUE ~ "Middle"),
         absorb_comp_type = case_when(absorb_comp < -.72 ~ "Low",
                                     absorb_comp > .61 ~ "High",
                                     TRUE ~ "Middle"))
frq(dat$Absorptive_Type)
frq(dat$absorb_comp_type)

```



```{r}
ggplot(dat, aes(shock_facs_comp, ability_recover, color=absorb_comp_type)) + #Absorptive_Type)) + 
  #geom_point() + 
  stat_smooth(se=F) +
  scale_y_continuous(limits=c(2,6),
                     breaks=2:6) + 
  scale_color_manual(values=c(medium_blue, usaid_red, medium_grey)) + 
  labs(x="Shock exposure",
       y="Ability\nto\nrecover",
       title="Absorptive capacity affects the relationship\nbetween shocks and the ability to recover") +
  theme(axis.title.y=element_text(angle=0, vjust=.5),
        legend.title=element_blank())

ggsave(here("output/viz/ability to recover shocks absorp.png"),
            device="png",
            type="cairo",
            height=4,
            width=7)

```
```{r}

abs3 <- svyglm(fies_raw ~ absorb_comp + #Absorptive_Capacity +
               shock_facs_comp + urban + as.factor(county),
             design=svydat)

summary(abs3)

```
```{r}

abs4 <- svyglm(fies_raw ~ Group_participation +
                 Emergency_planning + 
                 Donor_activity + 
               shock_exposure_comp + as.factor(county),
             design=svydat)

summary(abs4)

```



```{r}

abs5 <- svyglm(ability_recover ~ Group_participation +
                 Emergency_planning + 
                 Donor_activity + 
               shock_exposure_comp + as.factor(county),
             design=svydat)

summary(abs5)

```

```{r}

abs6 <- svyolr(ordered(ability_recover) ~ Group_participation +
                 Emergency_planning + 
                 Donor_activity + 
               shock_exposure_comp + as.factor(county),
               method="probit",
               design=svydat)

summary(abs6)

```

```{r}

abs7 <- svyolr(ordered(ability_recover) ~ grp_facs_comp + bonding_capital_raw + q_401_r_bin + 
               ews_comp + emerg_sum + donor_act +
               shock_facs_comp,
               method="probit",
               design=svydat)

summary(abs7)

```

```{r}

abs8 <- svyolr(ordered(ability_recover) ~ grp_facs_comp + bonding_capital_raw + q_401_r_bin + 
               ews_comp + emerg_sum + donor_act +
               shock_facs_comp + urban + as.factor(county),
               method="probit",
               design=svydat)

summary(abs8)

```

```{r}

abs10 <- svyglm(ability_recover ~ absorb_comp + #Absorptive_Capacity +
               shock_facs_comp + urban + as.factor(county),
             design=svydat)

summary(abs10)

```
```{r}
plotreg(abs10,
        omit.coef = "(Intercept)")
```


```{r}

frq(dat$resil_c)
svyrdat %>%
  summarize(survey_mean(resil_c, na.rm=T))

abs9 <- svyglm(resil_c ~ grp_facs_comp + bonding_capital_raw + q_401_r_bin + 
               ews_comp + emerg_sum + donor_act +
               shock_facs_comp + as.factor(county) + urban,
               design=svydat)

summary(abs9)

```



```{r}

```


##### second try

```{r}
absorp <- dat %>%
  select(grp_latent,
         bonding_fac,
         access_remittances=q_401_r_bin,
         ews_latent,
         emerg_fac,
         donor_act)

fa.parallel(absorp)
,
            cor="mixed")
```
2 factors, 1 component

```{r}
fa_absorp <- fa(absorp,
                scores="tenBerge",
                fm="ml")

fa_absorp

```

```{r}

fa_absorp_ldngs <- fa_absorp$loadings %>%
  unclass() %>%
  as.data.frame() %>%
  rownames_to_column("item") %>%
  mutate(#description=loc_sum[,2],
         description=c("Informal safety nets",
                       "Bonding social capital",
                       "Access to remittances",
                       "Early warning systems",
                       "Emergency action planning",
                       "Access to humanitarian support")) %>%
  select(1,3,2)

fa_absorp_ldngs

write_csv(fa_absorp_ldngs, here("output/tables/resilience/absorptive capacity loadings.csv"))

fa_absorp_gt <- fa_absorp_ldngs %>%
  gt()

fa_absorp_gt

gtsave(fa_absorp_gt, here("output/tables/resilience/absorptive capacity loadings.rtf"))
```


```{r}
fa_absorp_scrs <- fa_absorp$scores %>%
  unlist() %>%
  as.data.frame()

dat <- dat %>%
  mutate(absorp_latent = fa_absorp_scrs$ML1,
         absorp_latent_resc = scales::rescale(absorp_latent, c(0,100)))

```

```{r}
absorp_mn <- svyrdat %>%
  summarize(absorp = survey_mean(absorp_latent_resc, na.rm=T)) %>%
  mutate(lower=absorp-1.96*absorp_se,
         upper=absorp+1.96*absorp_se)

absorp_mn

```

```{r}

describe(dat$absorp_latent_resc)
ggplot(dat, aes(absorp_latent)) + 
  geom_density()
```

### Ability to recover

```{r}
ggplot(dat, aes(absorp_latent_resc, ability_recover)) + 
  #geom_point() + 
  #stat_smooth() + 
  stat_smooth(method="lm", color=medium_blue, size=2) +
  scale_x_continuous(breaks=seq(0,100,20)) +
  scale_y_continuous(limits=c(2,6),
                     breaks=2:6) + 
  labs(x="Absorptive resilience capacity",
       y="Ability\nto\nrecover") + 
  theme(axis.title.y=element_text(angle=0, vjust=.5))

ggsave(here("output/viz/models/absorp recover.png"),
       device="png",
       type="cairo",
       height=4,
       width=7)

```

```{r}
l1 <- svyolr(ordered(ability_recover) ~ absorp_latent + conflict + shock_exposure_index + 
               household_members + as.factor(hh_head_sex) + urban + as.factor(county),
             method="probit",
             design=svyrdat)
summary(l1)

```
```{r}
library(stargazer)
tbl_regression(l1)
stargazer(l1)
texreg(l1)
summ(l1)
svyregress.display(l1.1) %>%
  kable()
tab_model(l1,
          transform=NULL,
          #collapse.ci=T,
          #show.p = F,
          show.se=T,
          string.est="Estimate",
          dv.labels="Ability to Recover (2-6)",
          terms=c("absorp_latent",
                  "conflict",
                  "shock_exposure_index",
                  "household_members",
                  "as.factor(hh_head_sex)2",
                  "urban"),
          pred.labels=c("Absorptive Resilience Capacity (0-100)",
                        "Household involved in conflict (0/1)",
                        "Shock Exposure Index (0-128)",
                        "Household size (1-25)",
                        "Female-headed household (0/1)",
                        "Urban locality (0/1)"),
          #drop="(county)",
          title="Ordered probit model, ability to recover from shocks",
          file=here("output/models/absorptive ability to recover full.doc"))
          
```


```{r}
l1.1 <- svyglm(ability_recover_bin ~ absorp_latent_resc + conflict + shock_exposure_index + 
               household_members + as.factor(hh_head_sex) + urban + as.factor(county),
             #family="quasibinomial",
             design=svyrdat)
summary(l1.1)
margins(l1.1)
```
```{r}
?margins

a <- cplot(l1.1)
describe(a)

ggplot(a, aes(xvals, yvals)) +
  geom_vline(xintercept=32.5, color="darkgoldenrod3", size=1) + 
  stat_smooth(color=medium_blue, size=1) + 
  geom_ribbon(aes(ymin=lower, ymax=upper),
              fill=light_grey, alpha=.4) +
  stat_smooth(aes(y=lower),
              linetype="dotdash",
              color=medium_blue,
              alpha=.6) + 
  stat_smooth(aes(y=upper),
              linetype="dotdash",
              color=medium_blue,
              alpha=.6) +
  scale_x_continuous(breaks=seq(0,100,10)) +
  scale_y_continuous(limits=c(.2,1.05),
                     breaks=seq(.2,1,.1),
                     labels=percent_format(accuracy=1)) +
  geom_segment(aes(y=0, yend=.91, x=32, xend=33), color="darkgoldenrod3") +
  labs(x="Absorptive resilience capacity",
       y="Able to\nrecover") +
  theme(axis.title.y=element_text(angle=0, vjust=.5))

ggsave(here("output/models/Absorptive hungry ribbon.png"),
       device="png",
       type="cairo",
       height=4,
       width=7)

```

```{r}
l1.2 <- svyglm(ability_recover_bin ~ absorp_latent_resc + conflict + shock_exposure_index + 
               household_members + as.factor(hh_head_sex) + urban + as.factor(county),
             family="quasibinomial",
             design=svyrdat)
summary(l1.2)
margins(l1.2)

l1.2_marg <- cplot(l1.2)
describe(l1.2_marg)

ggplot(l1.2_marg, aes(xvals, yvals)) +
  geom_vline(xintercept=32.5, color="darkgoldenrod3", size=1) + 
  stat_smooth(color=medium_blue, size=1) + 
  geom_ribbon(aes(ymin=lower, ymax=upper),
              fill=light_grey, alpha=.4) +
  stat_smooth(aes(y=lower),
              linetype="dotdash",
              color=medium_blue,
              alpha=.6) + 
  stat_smooth(aes(y=upper),
              linetype="dotdash",
              color=medium_blue,
              alpha=.6) +
  scale_x_continuous(breaks=seq(0,100,10)) +
  scale_y_continuous(limits=c(0,1.05),
                     breaks=seq(0,1,.1),
                     labels=percent_format(accuracy=1)) +
  labs(x="Absorptive resilience capacity",
       y="Able to\nrecover") +
  theme(axis.title.y=element_text(angle=0, vjust=.5))

ggsave(here("output/models/Absorptive able to recover bin.png"),
       device="png",
       type="cairo",
       height=4,
       width=7)



```
### Food insecurity

```{r}
l2 <- svyglm(fies4_fac_resc ~ absorp_latent + conflict + shock_exposure_index + 
               household_members + as.factor(hh_head_sex) + urban + as.factor(county),
             design=svyrdat)
summary(l2)

```

```{r}
describe(dat$absorp_latent_resc)

l3 <- svyglm(q_432 ~ absorp_latent_resc + conflict + shock_exposure_index + 
               household_members + as.factor(hh_head_sex) + urban + as.factor(county),
             design=svyrdat)
summary(l3)

```

```{r}
l3_marg <- cplot(l3) %>%
  mutate(upper=ifelse(upper>1,1,upper))
```


```{r}
describe(dat$q_432)
svyrdat %>%
  summarize(absorp = survey_mean(absorp_latent_resc, na.rm=T),
            hungry = survey_mean(q_432, na.rm=T))

l3_marg

```

```{r}

ggplot(l3_marg, aes(xvals, yvals)) + 
  geom_ribbon(aes(ymin=lower, ymax=upper), fill=light_grey, alpha=.4) +
  geom_vline(xintercept=32.5, color="darkgoldenrod3", size=1) +
  stat_smooth(color=medium_blue, size=1) +
  stat_smooth(aes(y=lower), linetype="dotdash", color=medium_blue, alpha=.6) +
  stat_smooth(aes(y=upper), linetype="dotdash", color=medium_blue, alpha=.6) +
  scale_x_continuous(breaks=seq(0,100,10)) +
  scale_y_continuous(limits=c(.6,1),
                     breaks=seq(.6,1,.05),
                     labels=percent_format(accuracy=1)) +
  geom_segment(aes(y=0, yend=.91, x=32, xend=33), color="darkgoldenrod3") +
  labs(x="Absorptive Resilience Capacity",
       y="Went to\nbed hungry") +
  theme(axis.title.y=element_text(angle=0, vjust=.5))

ggsave(here("output/models/Absorptive hungry ribbon.png"),
       device="png",
       type="cairo",
       height=4,
       width=7)

```

```{r}

l3_bin <- svyglm(q_432 ~ absorp_latent + conflict + shock_exposure_index + 
               household_members + as.factor(hh_head_sex) + urban + as.factor(county),
             design=svyrdat)
summary(l3_bin)

```
```{r}

tab_model(l3_bin,
          p.val="wald")

tab_model(l3_bin,
          #transform=NULL,
          #collapse.ci=T,
          #show.p = F,
          p.val="wald",
          show.se=T,
          digits=3,
          string.est="Estimate",
          dv.labels="Went to bed hungry (0/1)",
          terms=c("absorp_latent",
                  "conflict",
                  "shock_exposure_index",
                  "household_members",
                  "as.factor(hh_head_sex)2",
                  "urban"),
          pred.labels=c("Absorptive Resilience Capacity (-1 to 3)",
                        "Household involved in conflict (0/1)",
                        "Shock Exposure Index (0-128)",
                        "Household size (1-25)",
                        "Female-headed household (0/1)",
                        "Urban locality (0/1)"),
          #drop="(county)",
          title="Linear probability model, food insecurity",
          file=here("output/models/absorptive hungry lpm.doc"))
        

library(tab)
tabglm(l3_bin)

library(huxtable)
huxreg(l3)
```


```{r}

l3_log <- svyglm(q_432 ~ absorp_latent_resc + conflict + shock_exposure_index + 
               household_members + as.factor(hh_head_sex) + urban + as.factor(county),
             design=svyrdat,
             family="quasibinomial")
summary(l3_log)


```

```

```{r}
l3_log_marg <- cplot(l3_log) %>%
  mutate(upper=ifelse(upper>1,1,upper))
  
ggplot(l3_log_marg, aes(xvals, yvals)) + 
  geom_ribbon(aes(ymin=lower, ymax=upper), fill=light_grey, alpha=.4) +
  geom_vline(xintercept=32.5, color="darkgoldenrod3", size=1) +
  stat_smooth(color=medium_blue, size=1) +
  stat_smooth(aes(y=lower), linetype="dotdash", color=medium_blue, alpha=.6) +
  stat_smooth(aes(y=upper), linetype="dotdash", color=medium_blue, alpha=.6) +
  scale_x_continuous(breaks=seq(0,100,10)) +
  scale_y_continuous(limits=c(.6,1),
  breaks=seq(.6,1,.05),
  labels=percent_format(accuracy=1)) +
  geom_segment(aes(y=0, yend=.91, x=32, xend=33), color="darkgoldenrod3") +
  labs(x="Absorptive Resilience Capacity",
  y="Went to\nbed hungry") +
  theme(axis.title.y=element_text(angle=0, vjust=.5))

ggsave(here("output/models/Absorptive hungry ribbon logistic.png"),
       device="png",
       type="cairo",
       height=4,
       width=7)
       
```



```{r}

l3_dis <- svyglm(q_432 ~ grp_latent + bonding_fac + q_401_r_bin + 
               ews_latent + emerg_fac + donor_act +
               shock_exposure_index + conflict + 
               household_members + as.factor(hh_head_sex) + urban + as.factor(county),
             design=svydat)

summary(l3_dis)

describe(dat$shock)

```

```{r}

tab_model(l3_dis,
          #transform=NULL,
          #collapse.ci=T,
          #show.p = F,
          p.val="wald",
          show.se=T,
          digits=3,
          string.est="Estimate",
          dv.labels="Went to bed hungry (0/1)",
          terms=c("grp_latent",
          "bonding_fac",
          "q_401_r_bin",
          "ews_latent",
          "emerg_fac",
          "donor_act",
                  "shock_exposure_index",
                  "conflict",
                  "household_members",
                  "as.factor(hh_head_sex)2",
                  "urban"),
          pred.labels=c("Group participation (-1 to 3)",
          "Bonding social capital",
          "Access to remittances",
          "Early warning systems",
          "Emergency action planning",
          "Access to humanitarian aid",
                           "Shock Exposure Index (0-128)",
                           "Experienced conflict (0/1)",
                        "Household size (1-25)",
                        "Female-headed household (0/1)",
                        "Urban locality (0/1)"),
          #drop="(county)",
          title="Components of absorptive capacity, food insecurity",
          file=here("output/models/absorptive components hungry lpm.doc"))
        
```

```{r}

l3_dis_t <- tidy(l3_dis) %>%
    mutate(lower = estimate - 1.96*std.error,
           upper = estimate + 1.96*std.error,
           color=case_when(lower > 0 ~ "#002F6C",
                           upper < 0 ~ "#BA0C2F",
                           TRUE ~ "#8C8985")) %>%
  .[1:12,] %>%
  filter(term!="(Intercept)") %>%
  mutate(term2 = c("Group participation (-1 to 3)",
                   "Bonding social capital (-1 to 1.5)",
                   "Access to remittances",
                   "Early warning systems (-1 to 2)",
                   "Emergency planning (-1 to 2)",
                   "Humanitarian assistance",
                   "Shock exposure (0-128)",
                   "Experienced conflict",
                   "Household size",
                   "Female-headed household",
                   "Urban locality")) %>%
  select(term, term2, everything())

l3_dis_t

describe(dat$emerg_fac)

```

```{r}
ggplot(l3_dis_t, aes(x=estimate, y=fct_reorder(term2, -estimate)), color = color, fill = color) +
    geom_vline(xintercept=0, color="darkgrey", size=1.2) +
    geom_errorbarh(aes(xmin=lower, xmax=upper), color=l3_dis_t$color, height=0, size=1.2, alpha = 0.7) +
    geom_label(aes(label=paste(round(estimate,3)*100, "%", sep="")),color = l3_dis_t$color, size=4.5) +
    scale_x_continuous(breaks=seq(-.15,.1,.05),
                       limits=c(-.15,.1),
                       labels = scales::percent_format(accuracy=1)) +
    labs(x = "", y = "")

#,
         title="Absorptive capacity measures\nand food insecurity")
#, 
         caption="Outcome is the probability of the household reporting that members\nof the household went to bed hungry in the previous 30 days\n\nOutcome mean 88%")

ggsave(here("output/viz/models/absorptive hungry regplot.png"),
            device="png",
            type="cairo",
            height=5,
            width=7)
```




### Absorptive capacity by county

```{r}
absorp_cnty <- svyrdat %>%
  group_by(county) %>%
  summarize(AbsorptiveCapacity=survey_mean(absorp_latent_resc, na.rm=T)) %>%
  mutate(lower=AbsorptiveCapacity - 1.96*AbsorptiveCapacity_se,
         upper=AbsorptiveCapacity + 1.96*AbsorptiveCapacity_se)

absorp_cnty

write_csv(absorp_cnty, here("output/tables/Absorptive capacity by county weighted.csv"))

```



### stuff


```{r}
dat <- dat %>%
  mutate(log_exposure = log(shock_exposure_index+1))
describe(dat$log_exposure)
```


```{r}
frq(dat$resil_c)
```


```{r}
frq(dat$ability_recover)
```

```{r}
describe(dat$arssi)
```

```{r}
ggplot(dat, aes(shock_exposure_index, arssi)) + 
  geom_point() + 
  stat_smooth()
```

```{r}
ggplot(dat, aes(log_exposure, arssi)) + 
  geom_point() + 
  stat_smooth()
```

```{r}
ggplot(dat, aes(shock_exposure_index, ability_recover)) + 
  geom_point() + 
  stat_smooth(method="lm")
```

```{r}
ggplot(dat, aes(log_exposure, ability_recover)) + 
  geom_point() + 
  stat_smooth(method="lm")
```



```{r}
l1 <- stan_glm(ability_recover ~ log_exposure,
               data=dat)

summary(l1, digits=3)
```
```{r}
l2 <- stan_polr(ordered(ability_recover) ~ log_exposure,
               method="probit",
               prior=R2(.25),
               data=dat)

summary(l2, digits=3)
```


### 
### Ordered probit

```{r}
p1 <- polr(ordered(ability_recover) ~ log_exposure,
          method="probit",
          data=dat)

summary(p2)
```

```{r}
b2 <- brm(ability_recover ~ log_exposure,
          family=cumulative("probit"),
          backend="cmdstanr",
          data=dat)
```


```{r}
c1 <- stan_glm(resil_c ~ shock_exposure_index,
               data=dat)

summary(c1, digits=3)
```

