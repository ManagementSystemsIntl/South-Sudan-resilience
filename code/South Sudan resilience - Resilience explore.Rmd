---
title: "Resilience explore"
author: "Dan Killian"
date: "11/19/2021"
output: 
  bookdown::html_document2:
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float: true
    theme: paper
    fig.caption: true
    code_folding: hide
    df_print: kable
---

```{r global_options, include=F, warning=F, message=F, echo=F, error=F}
# standard figure size and generate clean output
knitr::opts_chunk$set(fig.height=4, fig.width=6, warning=FALSE, message=FALSE, cache=TRUE, error=T, echo=T)

library(here)

#knitr::opts_knit$set(root.dir="~/South Sudan resilience - MSI") # doesn't seem to work

source(here("code/00 South Sudan resilience - prep.R"))

```

# Introduction

The South Sudan Monitoring and Evaluation Support Project (MESP) is conducting a household resilience survey in 13 counties. The purpose of this household survey is to obtain baseline data in the target areas for the indicators included in the Mission's Performance Management Plan (PMP) and the Community Roadmap, in support of USAID/South Sudan's Strategic Framework (2020-2024).

MESP has completed data collection in six counties, and as of October 2021 is carrying out data collection in the remaining seven counties. The study team is currently reviewing the data from six counties in advance of analysis of the full set of 13 counties. This document is one of a series of documents to review various measures and indices relating to resilience.

# Resilience

## Absorptive capacity

### Community group participation

```{r}

grps <- dat %>%
  select(grp_water:grp_animalherding)

map(grps, frq)

```


```{r}
frq(dat$grp_sum)
```

```{r}
ggplot(dat, aes(grp_sum)) +
  geom_bar(fill=light_blue,
           width=.5)
```


```{r}

#library(ltm)

l1 <- ltm(grps ~ z1)

l1
#summary(l1)

```

Credit, savings, and self-help groups have the highest 'difficulty'

Cattle protection and animal herding have the highest discrimination


```{r}
plot(l1, type="ICC")
```

```{r}
plot(l1, type="IIC")
```

```{r}
plot(l1, type="IIC",
     items=0)
```
```{r}

fa.parallel(grps,
            cor="tet")

# 5 factors, 3 components

fa_grps_5 <- fa(grps,
                 nfactors=5,
                 scores="tenBerge",
                 fm="ml",
                 cor="tet")


fa_grps_5

```

ML3: cattle herding, cattle protection, cattle raiding, animal herding

ML4: women group, mothers group, religious group

ML2: savings group, credit group

ML1: sports, youth 

ML5: natural resource management, self-help, water, land management

Captures 75 percent of the variance of all items

Fit statistics good but not great (Tucker-Lewis 86 percent, RMSEA .14)

```{r}
prin_grps <- principal(grps,
                       cor="tet")
prin_grps
```

```{r}
prin_grps_scrs <- data.frame(prin_grps$scores)
describe(prin_grps_scrs)
```

```{r}
dat <- dat %>%
  mutate(grp_participate_comp=prin_grps_scrs$PC1)

ggplot(dat, aes(grp_participate_comp)) + 
  geom_density()
```
```{r}
g1 <- svyglm(fies_raw ~ grp_participate_comp + shock_exposure_index + 
               as.factor(county),
             design=svydat)

summary(g1)
```
```{r}
ggplot(dat, aes(grp_sum, grp_participate_comp)) +
  geom_point(color=light_blue) + 
  stat_smooth() +
  scale_x_continuous(breaks=1:16)
```


### Bonding social capital

```{r}
frq(dat$bonding_capital_raw)
```

```{r}
bond <- dat %>%
  select(q_490,
         rc_q_491,
         q_494,
         rc_q_495)

map(bond, frq)
```

```{r}

irt_bond <- ltm(bond ~ z1)

irt_bond

#summary(l1)

```

```{r}
plot(irt_bond, type="ICC")
```

```{r}
plot(irt_bond, type="IIC")
```

```{r}
plot(irt_bond, 
     type="IIC",
     items=0)
```

```{r}

fa.parallel(bond,
            cor="tet")

# 2 factors, 1 components

fa_bond_2 <- fa(bond,
                nfactors=2,
                scores="tenBerge",
                fm="ml",
                cor="tet")


fa_bond_2

```

```{r}

fa_bond_1 <- fa(bond,
                nfactors=1,
                #scores="tenBerge",
                fm="ml",
                cor="tet")


fa_bond_1

```



```{r}
prin_bond <- principal(bond)
prin_bond
```
```{r}
frq(dat$bonding_capital_raw)

dat <- dat %>%
  mutate(bonding_capital_comp = prin_bond$scores)

describe(dat$bonding_capital_comp)

```

```{r}
ggplot(dat, aes(bonding_capital_comp)) + 
  geom_density()
```

```{r}
frq(dat$bonding_capital_comp)
```


```{r}
ggplot(dat, aes(bonding_capital_raw, bonding_capital_comp)) + 
  geom_point(color=light_blue) + 
  stat_smooth()
```


```{r}
ggplot(dat, aes(bonding_capital_raw)) + 
  geom_bar()
```

```{r}
g2 <- svyglm(fies_raw ~ grp_participate_comp + bonding_capital_comp + shock_exposure_index + 
               as.factor(county),
             design=svydat)

summary(g2)
```

### Access to savings / remittances

```{r}
library(sjPlot)

frq(dat$q_401_a)
frq(dat$q_401_a_bin)

inc <- dat %>%
  select(q_401_a_bin,
         q_401_b_bin,
         q_401_c_bin,
         q_401_d_bin,
         q_401_e_bin,
         q_401_f_bin,
         q_401_g_bin,
         q_401_h_bin,
         q_401_i_bin,
         q_401_j_bin,
         q_401_k_bin,
         q_401_l_bin,
         q_401_m_bin,
         q_401_n_bin,
         q_401_o_bin,
         q_401_p_bin,
         q_401_q_bin,
         q_401_r_bin,
         q_401_s_bin,
         q_401_t_bin)

map(inc, frq)
#sjt.stackfrq(inc)

```

```{r}
fa.parallel(inc,
            cor="tet")
```
7 factors, 5 components

#### 7 factors

```{r}
fa_inc_7 <- fa(inc,
               nfactors=7,
               scores="tenBerge",
               fm="ml",
               cor="tet")
fa_inc_7
```

ML4: 

```{r}
fa_inc_7_ldngs <- as.matrix(fa_inc_7$loadings) %>%
  unclass() %>%
  as.data.frame() %>%
  rownames_to_column("varname") %>%
  select(1:8) %>%
  left_join(inc_key) %>%
  select(1,9:11, everything()) 

fa_inc_7_ldngs

```

ML4: d/c/b sheep/goat/cattle production/sales

ML5: petty trade / other employment

ML1: Ag wage labor

ML6: property rental / salaried work

ML3: Wage labor 

ML7: Wild bush / inheritance / safety net

ML2: Farmer

```{r}
fa_inc_7_scores <- data.frame(fa_inc_7$scores)

dat <- dat %>%
  mutate(inc_fac_livestocksales=fa_inc_7_scores$ML4,
         inc_fac_pettytrade=fa_inc_7_scores$ML5,
         inc_fac_agwage=fa_inc_7_scores$ML1,
         inc_fac_proprent=fa_inc_7_scores$ML6,
         inc_fac_wage=fa_inc_7_scores$ML3,
         inc_fac_safetynet=fa_inc_7_scores$ML7,
         inc_fac_farmer=fa_inc_7_scores$ML2)
```


```{r}
fa_inc_7_ldngsL <- fa_inc_7_ldngs %>% 
  pivot_longer(cols=5:11,
               names_to="factor",
               values_to="loading") %>%
  #arrange(factor) %>%
  mutate(significance=ifelse(loading>.3999, "Significant loading", ""))

#fa_inc_7_ldngsL

```


```{r fig.width=8.4}
ggplot(fa_inc_7_ldngsL, aes(x=loading, y=reorder(inc_code, desc(inc_code)), color=significance)) + 
  #geom_bar() + 
  geom_point() +
  scale_color_manual(values=c("grey60", medium_blue)) +
  scale_x_continuous(limits=c(.4,1),
                     breaks=c(.4,.8)) +
  scale_y_discrete(breaks=1:20,
                     labels=inc_labs) +
  facet_wrap(~factor, nrow=1) +
  faceted +
  theme(legend.position="none") +
  labs(x="",
       y="")
```
```{r}
ggsave(here("output/viz/fa inc 7 loadings.png"),
       device="png",
       type="cairo",
       height=5,
       width=10)
```

```{r}
g3 <- svyglm(fies_raw ~ grp_participate_comp + bonding_capital_comp + q_401_q_bin + q_401_r_bin + 
               shock_exposure_index + 
               as.factor(county),
             design=svydat)

summary(g3)
```

#### 5 factors

```{r}
fa_inc_5 <- fa(inc,
               nfactors=5,
               scores="tenBerge",
               fm="ml",
               cor="tet")
fa_inc_5
```

```{r}
fa_inc_5_ldngs <- as.matrix(fa_inc_5$loadings) %>%
  unclass() %>%
  as.data.frame() %>%
  rownames_to_column("varname") %>%
  select(1:6) %>%
  left_join(inc_key) %>%
  select(1,7:9, everything()) %>%
  pivot_longer(cols=5:9,
               names_to="factor",
               values_to="loading") %>%
  #arrange(factor) %>%
  mutate(significance=ifelse(loading>.3999, "Significant loading", ""))

fa_inc_5_ldngs

```

```{r fig.width=8.4}
ggplot(fa_inc_5_ldngs, aes(x=loading, y=reorder(inc_code, desc(inc_code)), color=significance)) + 
  #geom_bar() + 
  geom_point() +
  scale_color_manual(values=c("grey60", medium_blue)) +
  scale_x_continuous(breaks=seq(0,1,.5)) +
  scale_y_discrete(breaks=1:20,
                     labels=inc_labs) +
  facet_wrap(~factor, nrow=1) +
  faceted +
  theme(legend.position="none") +
  labs(x="",
       y="")
```




### Shock preparedness and mitigation

Nothing from the TANGO manual, but from our instrument we have early warning systems and emergency action plans

#### Early warning system

```{r}
ews <- dat %>%
  select(warn_hazards:warn_foodprices)

map(ews, frq)

```

```{r}
ltm_ews <- ltm(ews ~ z1)
ltm_ews
```

Price warnings least common; water, crops, and livestock most common

animal prices, general prices, and grazing highest discrimination

```{r}
ews_prin <- principal(ews)
ews_prin
```

```{r}
dat <- dat %>%
  mutate(ews_comp=ews_prin$scores)

describe(dat$ews_comp)
```

```{r}
ews_prin$weights
```
```{r}
ggplot(dat, aes(ews_comp)) +
  geom_density()
```


```{r}
ggplot(dat, aes(x=ews_comp)) + 
  stat_smooth(aes(y=warn_animalprices), color=light_blue, se=F) + 
  stat_smooth(aes(y=warn_prices), color=medium_blue, se=F) + 
  stat_smooth(aes(y=warn_grazing), color=usaid_red, se=F) +
  stat_smooth(aes(y=warn_livestock), color=dark_red, se=F) + 
  stat_smooth(aes(y=warn_crops), color=rich_black, se=F) + 
  stat_smooth(aes(y=warn_hazards), color=light_grey, se=F) 
  #geom_point(aes(y=warn_animalprices), color=light_blue) +
  #geom_point(aes(y=warn_prices), color=medium_blue)

```
```{r}
ggplot(dat, aes(y=ews_comp)) + 
  geom_point(aes(x=warn_sum), color=dark_grey, size=.6) + 
  stat_smooth(aes(x=warn_sum), color=dark_grey, se=F) +
  scale_x_continuous(breaks=1:11)

```

#### Emergency action plans

```{r}
frq(dat$q_612)
```

```{r}
emerg <- dat %>%
  select(emerg1:emerg4)
head(emerg)
```

```{r}
ltm_emerg <- ltm(emerg ~ z1)
ltm_emerg
```

```{r}
plot(ltm_emerg, type="ICC")
```

```{r}
plot(ltm_emerg, type="IIC")
```

```{r}
plot(ltm_emerg, 
     type="IIC",
     items=0)
```
```{r}
ltm_emerg2 <- ltm(emerg[,1:3] ~ z1)
ltm_emerg2
```

```{r}
plot(ltm_emerg2, type="ICC")
```
```{r}
plot(ltm_emerg2, type="IIC")
```

```{r}
plot(ltm_emerg2, 
     type="IIC",
     items=0)
```

```{r}
prin_emerg <- principal(emerg)
prin_emerg
```

```{r}
weights(prin_emerg)
```
```{r}
dat <- dat %>%
  mutate(emerg_comp = prin_emerg$scores)

describe(dat$emerg_comp)

ggplot(dat, aes(emerg_comp)) + 
  geom_density()
```



```{r}
prin_emerg2 <- principal(emerg[,1:3])
prin_emerg2
```


```{r}
dat <- dat %>%
  mutate(emerg_comp2 = prin_emerg2$scores)

describe(dat$emerg_comp2)

ggplot(dat, aes(emerg_comp2)) + 
  geom_density()
```

```{r}
ggplot(dat, aes(emerg_comp, emerg_sum)) + 
  geom_point(color="blue") + 
  stat_smooth(method="lm")
```

### Humanitarian assistance 

```{r}
frq(dat$donor_act)
```

### Modeling components of absorptive capacity

```{r}

abs1 <- svyglm(fies_raw ~ grp_participate_comp + bonding_capital_raw + q_401_r_bin + 
                 ews_comp + emerg_sum + donor_act +
               shock_exposure_comp,
             design=svydat)

summary(abs1)

```

```{r}

abs2 <- svyglm(fies_raw ~ grp_participate_comp + bonding_capital_raw + q_401_r_bin + 
               ews_comp + emerg_sum + donor_act +
               shock_exposure_comp + as.factor(county),
             design=svydat)

summary(abs2)

```
### Absorptive capacity factor analysis

```{r}
absorp <- dat %>%
  select(grp_participate_comp,
         bonding_capital_raw,
         access_remittances=q_401_r_bin,
         ews_comp,
         emerg_sum,
         donor_act)

fa.parallel(absorp,
            cor="mixed")
```
3 factors, 2 components

```{r}
fa_absorp_3 <- fa(absorp,
                  nfactors=3,
                  scores="tenBerge",
                  fm="ml",
                  cor="mixed")

fa_absorp_3
```
ML1: civil society / group participation

ML2: Emergency planning

ML3: donor activity, bonding capital

50 percent of variance explained. No fit statistics. 

```{r}
fa_absorp_3_scrs <- fa_absorp_3$scores %>%
  as.data.frame() %>%
  set_names(nm=c("Group_participation", "Emergency_planning", "Donor_activity"))

dat <- dat %>%
  mutate(Group_participation=fa_absorp_3_scrs$Group_participation,
         Emergency_planning = fa_absorp_3_scrs$Emergency_planning,
         Donor_activity = fa_absorp_3_scrs$Donor_activity)

```

#### Absorptive factors factor analysis

```{r}
absorp_facs <- dat %>%
  select(Group_participation,
         Emergency_planning,
         Donor_activity)

fa.parallel(absorp_facs)
```

1 factor, 1 component

```{r}
fac_absorp_facs <- fa(absorp_facs,
                      #scores="tenBerg",
                      fm="ml")

fac_absorp_facs

```
45 percent of variance explained. No fit statistics. 

```{r}
prin_absorp_facs <- principal(absorp_facs)
prin_absorp_facs
```

62 percent of variance explained


```{r}
prin_absorp_facs_scrs <- prin_absorp_facs$scores %>%
  as.data.frame()

dat <- dat %>%
  mutate(Absorptive_Capacity = prin_absorp_facs_scrs$PC1)

#describe(dat$Absorptive_Capacity)

quantile(dat$Absorptive_Capacity, probs=seq(0,1,.25), na.rm=T)

```

```{r}
dat <- dat %>%
  mutate(Absorptive_Type = case_when(Absorptive_Capacity < -.79 ~ "Low",
                                     Absorptive_Capacity > .61 ~ "High",
                                     TRUE ~ "Middle"))
frq(dat$Absorptive_Type)

```



```{r}
ggplot(dat, aes(shock_exposure_comp, fies_raw, color=Absorptive_Type)) + 
  #geom_point() + 
  stat_smooth(se=F) 
+
  scale_y_continuous(limits=c(7.5,8),
                     breaks=6:8)

```
```{r}

abs3 <- svyglm(fies_raw ~ Absorptive_Capacity +
               shock_exposure_comp + as.factor(county),
             design=svydat)

summary(abs3)

```
```{r}

abs4 <- svyglm(fies_raw ~ Group_participation +
                 Emergency_planning + 
                 Donor_activity + 
               shock_exposure_comp + as.factor(county),
             design=svydat)

summary(abs4)

```



```{r}

abs5 <- svyglm(ability_recover ~ Group_participation +
                 Emergency_planning + 
                 Donor_activity + 
               shock_exposure_comp + as.factor(county),
             design=svydat)

summary(abs5)

```

```{r}

abs6 <- svyolr(ordered(ability_recover) ~ Group_participation +
                 Emergency_planning + 
                 Donor_activity + 
               shock_exposure_comp + as.factor(county),
               method="probit",
               design=svydat)

summary(abs6)

```

```{r}

abs7 <- svyolr(ordered(ability_recover) ~ grp_participate_comp + bonding_capital_raw + q_401_r_bin + 
               ews_comp + emerg_sum + donor_act +
               shock_exposure_comp,
               method="probit",
               design=svydat)

summary(abs7)

```



```{r}

```





### stuff


```{r}
dat <- dat %>%
  mutate(log_exposure = log(shock_exposure_index+1))
describe(dat$log_exposure)
```


```{r}
frq(dat$resil_c)
```


```{r}
frq(dat$ability_recover)
```

```{r}
describe(dat$arssi)
```

```{r}
ggplot(dat, aes(shock_exposure_index, arssi)) + 
  geom_point() + 
  stat_smooth()
```

```{r}
ggplot(dat, aes(log_exposure, arssi)) + 
  geom_point() + 
  stat_smooth()
```

```{r}
ggplot(dat, aes(shock_exposure_index, ability_recover)) + 
  geom_point() + 
  stat_smooth(method="lm")
```

```{r}
ggplot(dat, aes(log_exposure, ability_recover)) + 
  geom_point() + 
  stat_smooth(method="lm")
```



```{r}
l1 <- stan_glm(ability_recover ~ log_exposure,
               data=dat)

summary(l1, digits=3)
```
```{r}
l2 <- stan_polr(ordered(ability_recover) ~ log_exposure,
               method="probit",
               prior=R2(.25),
               data=dat)

summary(l2, digits=3)
```


### 
### Ordered probit

```{r}
p1 <- polr(ordered(ability_recover) ~ log_exposure,
          method="probit",
          data=dat)

summary(p2)
```

```{r}
b2 <- brm(ability_recover ~ log_exposure,
          family=cumulative("probit"),
          backend="cmdstanr",
          data=dat)
```


```{r}
c1 <- stan_glm(resil_c ~ shock_exposure_index,
               data=dat)

summary(c1, digits=3)
```

