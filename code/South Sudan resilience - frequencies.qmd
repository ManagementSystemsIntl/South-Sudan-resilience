---
title: "South Sudan resilience baseline"
subtitle: "Survey frequencies"
author: "Dan Killian"
toc: true
toc-depth: 3
number-sections: true
format: 
  html:
    code-fold: true
editor: visual
---

```{r global_options, include=F, warning=F, message=F, echo=F, error=F}

# standard figure size and generate clean output
knitr::opts_chunk$set(autodep=T, fig.height=4, fig.width=6, warning=FALSE, message=FALSE, cache=TRUE, error=T, echo=T)

library(here)
source("00 South Sudan resilience - prep.R")
```

# Household Income and Consumption

## Overall

```{r}
inc_ov_tmp <- svyrdat %>%
  group_by() %>%
  summarize(crop_production=survey_mean(q_401_a_bin),
            cattle_production = survey_mean(q_401_b_bin),
            goat_production = survey_mean(q_401_c_bin),
            sheep_production = survey_mean(q_401_d_bin),
            fishing = survey_mean(q_401_e_bin),
            Agwage_within = survey_mean(q_401_f_bin),
            Agwage_without = survey_mean(q_401_g_bin),
            nonAgwage_within = survey_mean(q_401_h_bin),
            nonAgwage_without = survey_mean(q_401_i_bin),
            salary = survey_mean(q_401_j_bin),
            bush_products = survey_mean(q_401_k_bin),
            honey = survey_mean(q_401_l_bin),
            petty_trade_other = survey_mean(q_401_m_bin),
            petty_trade_own = survey_mean(q_401_n_bin),
            ownbiz_ag = survey_mean(q_401_o_bin), 
            ownbiz_nonag = survey_mean(q_401_p_bin),
            rent = survey_mean(q_401_q_bin),
            remit = survey_mean(q_401_r_bin),
            gifts = survey_mean(q_401_s_bin),
            safety_net = survey_mean(q_401_t_bin)) 

```

```{r}
ov_cols <- seq_len(40) %% 2

inc_ov_mn <- inc_ov_tmp[, ov_cols==T] %>%
    pivot_longer(cols=1:20,
               names_to="income_source",
               values_to="Percent") %>%
  mutate(inc_lab=inc_labs) %>%
  relocate(inc_lab, .after=income_source)

inc_ov_se <- inc_ov_tmp[,ov_cols==F] %>%
  pivot_longer(cols=1:20,
               names_to="income_source",
               values_to="se")

inc_ov <- inc_ov_mn %>%
  bind_cols(inc_ov_se[,2]) %>%
  mutate(margin=se*1.96,
         lower=Percent-margin,
         upper=Percent+margin)

inc_gt <- inc_ov %>%
  select(-1, -4) %>%
  arrange(desc(Percent)) %>%
  gt() %>%
  fmt_percent(2:5,
              decimals=1) %>%
  cols_label(inc_lab="Income source") %>%
  tab_source_note("Survey instsrument items 401a-t")
  

inc_gt

```

## By county

### Long format, with confidence intervals

```{r}
inc_cnty_tmp <- svyrdat %>%
  group_by(county) %>%
  summarize(crop_production=survey_mean(q_401_a_bin),
            cattle_production = survey_mean(q_401_b_bin),
            goat_production = survey_mean(q_401_c_bin),
            sheep_production = survey_mean(q_401_d_bin),
            fishing = survey_mean(q_401_e_bin),
            Agwage_within = survey_mean(q_401_f_bin),
            Agwage_without = survey_mean(q_401_g_bin),
            nonAgwage_within = survey_mean(q_401_h_bin),
            nonAgwage_without = survey_mean(q_401_i_bin),
            salary = survey_mean(q_401_j_bin),
            bush_products = survey_mean(q_401_k_bin),
            honey = survey_mean(q_401_l_bin),
            petty_trade_other = survey_mean(q_401_m_bin),
            petty_trade_own = survey_mean(q_401_n_bin),
            ownbiz_ag = survey_mean(q_401_o_bin), 
            ownbiz_nonag = survey_mean(q_401_p_bin),
            rent = survey_mean(q_401_q_bin),
            remit = survey_mean(q_401_r_bin),
            gifts = survey_mean(q_401_s_bin),
            safety_net = survey_mean(q_401_t_bin)) 
```

```{r}
cnty_cols <- seq_len(41) %% 2

inc_cnty_mn <- inc_cnty_tmp[, cnty_cols==F] %>%
  mutate(county=county_key$county) %>%
  relocate(county, .before=1) %>%
  pivot_longer(cols=2:21,
               names_to="income_source",
               values_to="Percent") %>%
  mutate(inc_lab = rep(inc_labs, 13))

inc_cnty_se <- inc_cnty_tmp[,cnty_cols==T] %>%
  pivot_longer(cols=2:21,
               names_to="income_source",
               values_to="se")

inc_cnty <- inc_cnty_mn %>%
  bind_cols(inc_cnty_se[,3]) %>%
  mutate(margin=se*1.96,
         lower=Percent-margin,
         upper=Percent+margin) %>%
  relocate(inc_lab, .after=income_source)

inc_cnty_gt <- inc_cnty %>% 
  select(-2, -5) %>%
  gt() %>%
  fmt_percent(3:6, 
              decimals=1) %>%
  cols_label(county="County",
             inc_lab="Income source")

inc_cnty_gt
```

### Wide format to better show income source across county. 

```{r}

inc_cnty_wide <- inc_cnty %>%
  select(1,3,4) %>%
  as.data.frame() %>%
  pivot_wider(names_from=county,
              values_from=Percent)


inc_cnty_wide_gt <- inc_cnty_wide %>%
  gt() %>%
  fmt_percent(2:14,
              decimals=0) %>%
  cols_label(inc_lab="Income source")

inc_cnty_wide_gt
```

# Household involvement in the community

## Community group participation

```{r}

grps_sum <- read_csv(here("output/tables/resilience/groups weighted.csv"))

grps_sum_gt <- grps_sum %>%
  gt()

grps_sum_gt
```
