---
title: "South Sudan resilience baseline"
subtitle: "Demographic profiles" 
author: "Monitoring and Evaluation Support Project (MESP)"
toc: true
toc-depth: 3
number-sections: true
format:
  docx:
    reference-doc: USAID-report-template-02.docx
    highlight-style: github
#  html:
#    code-fold: true
execute: 
  echo: false
editor: visual
---

```{r global_options, include=F, warning=F, message=F, echo=F, error=F}

# standard figure size and generate clean output

knitr::opts_chunk$set(autodep=T, fig.height=4, fig.width=6, warning=FALSE, message=FALSE, cache=TRUE, error=F)#, echo=T)

library(here) 
source(here("code/00 South Sudan resilience - prep.R"))

#hh <- read_dta(here("data/local/SSD resilience baseline household roster.dta"))

# to switch to Word

# format:
#   docx:
#     reference-doc: USAID-report-template-02.docx
# always_allow_html: true

# ---
# title: "My Document"
# format:
#   docx:
#     toc: true
#     number-sections: true
#     highlight-style: github
# ---

```

```{r}

#frq(dat$county)
#table(dat$region, dat$county)
```

# Jur River (Bahr el Gazal)

```{r}
jur <- dat %>%
  filter(county=="Jur River")

jur_svyr <- svyrdat %>%
  filter(county=="Jur River")

jur_hh_svyr <- hh_srvyr %>%
  filter(county=="Jur River")

hhjur <- hh %>%
  filter(county=="Jur River")
```

## Age

```{r}
#frq(hhjur$sex)

#hhjur <- hhjur %>%
#  mutate()

#age_jur <- data.frame(table(hhjur$age_dec, hhjur$sex))

 age_jur <- hhjur %>%
   group_by(age_dec, sex) %>%
   summarize(sex_count=n()) %>%
   left_join(age_dec_key) %>%
   left_join(sex_key) %>%
   mutate(count=ifelse(sex_lab=="Male", sex_count, sex_count*-1)) %>%
   na.omit()
 
#age_jur %>%
#  flextable()

```

```{r}

age_dens <- ggplot(hhjur, aes(age)) + 
  stat_density(fill="dodgerblue2", alpha=.5) + 
  geom_vline(xintercept=mean(hhjur$age, na.rm=T), color="darkgoldenrod2", size=1) +
  scale_x_continuous(breaks=seq(0,80,10)) +
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  labs(x="",
       y="",
       title="Age, Jur River")

ggsave(here("output/viz/Jur River/age density, Jur River.png"),
       age_dens,
       device="png",
       type="cairo",
       height=4,
       width=7)
```

```{r echo=T}
include_graphics(here("output/viz/Jur River/age density, Jur River.png"))
```

```{r}

pyr <-  ggplot(age_jur, aes(age_lab, count, fill=sex_lab)) +
   geom_bar(stat="identity", alpha=.8, width=.6) +
   scale_fill_manual(values=c("dodgerblue2","maroon")) +
   coord_flip() +
   #scale_y_continuous(labels=age_dec_key$age_lab) +
   theme(legend.title=element_blank(),
         legend.position="bottom",
         axis.ticks.x=element_blank(),
         axis.text.x=element_blank()) +
   labs(x="",
        y="",
        title="Age pyramid\nJur River")

ggsave(here("output/viz/Jur River/age pyramid, Jur River.png"),
       device="png",
       type="cairo",
       height=4,
       width=7)

```

```{r echo=T}
include_graphics(here("output/viz/age pyramid, Jur River.png"))
```

## Education

### Literate

```{r}

lit <- ov_tab(jur_hh_svyr, literate, "literate", "Literate (6+)") 

no_ed <- ov_tab(jur_hh_svyr, no_educ, "no_educ", "No education (6+)")

prim_ed <- ov_tab(filter(jur_hh_svyr, age>11), prim_ed, "prim_ed", "Primary education (12+)")

sec_ed <- ov_tab(filter(jur_hh_svyr, age>17), sec_ed, "sec_ed", "Secondary education (18+)")

ed <- bind_rows(no_ed, lit, prim_ed, sec_ed)

#write_csv(ed, here("output/tables/Jur River/education hh.csv"))

ed_flx <- ed %>%
  select(`Education`=2, Number, Percent, `Confidence interval`=ci) %>%
  flextable() %>%
  set_formatter(Percent=function(x) sprintf("%.1f%%", x*100)) %>%
  width(j=c(1,4), width=1.7, unit="in") %>%
  align(align="center",
        part="header") %>%
  align(j=4,
        align="center") %>%
  add_footer_lines(values="Level of education in household")

ed_flx

#save_as_docx(ed_flx, path=here("output/tables/Jur River/ed_flx.docx"))

```

## Livelihoods

### Economic activity in last 10 years (Q314)

```{r}

ec_act_cnty_lst <- read_rds(here("output/tables/economic activity by county.rds"))

jur_ec <-ec_act_cnty_lst$`Jur River` %>%
  arrange(desc(freq))

jur_ec %>%
  ungroup() %>%
  select(Activity=activity_lab,
         Number,
         Percent=freq) %>%
#         `Rank within county`=rank) %>%
  flextable() %>%
  set_formatter(Percent=function(x) sprintf("%.1f%%", x*100)) %>%
  width(j=1, width=1.5, unit="in") %>%
  align(align="center",
        part="header")

# q1g_disag_flx <- q1g_disag %>% 
#   select(3,5:7, `Confidence interval`=13) %>%
#   flextable() %>%
#   set_table_properties(layout="autofit") %>%
#   add_footer_lines(values="Q315. Economic activity in past 10 years")
  # align(j=5, align="center") %>%
  # merge_v(j="Disaggregation") %>%
  # fix_border_issues() %>%
  # hline(i=c(1,3,7,10,12,15,18), border=smlbrdr) %>%
  # set_table_properties(layout="autofit") %>%
  # add_footer_lines(values="Q1. Seen USAID logo in past year")
  # 

#save_as_docx(q1g_disag_flx, path=here("output/tables/eval Q1/q1g_disag.docx"))

```

```{r}
# jur_314 <- data.frame(frq(hhjur$q_314)) %>%
#   select(2:4) %>%
#   na.omit() %>%
#   arrange(desc(frq)) %>%
#   mutate(percent=round(frq/sum(frq),3),
#          rank=rev(rank(frq)))
# 
# jur_314_gt <- jur_314 %>%
#   select(-1, Income=2) %>%
#   gt() 
# 
# jur_314_gt
```

### Income sources (Q401-Q402)

```{r}

inc_cnty_lst <- read_rds(here("output/tables/income sources by county.rds"))

jur_inc <- inc_cnty_lst$`Jur River`

jur_inc %>%
  ungroup() %>%
  select(`Income source`=inc_lab,
         #Number,
         Percent) %>%
#         `Rank within county`=rank) %>%
  flextable() %>%
  set_formatter(Percent=function(x) sprintf("%.1f%%", x*100)) %>%
  width(j=1, width=2, unit="in")

```

## Health

```{r}
#frq(hh$q_315)
#frq(hh$measles_vacc)

meas <- ov_tab(filter(jur_hh_svyr, !is.na(measles_vacc)), measles_vacc, "measles_vacc", "Vaccinated for measles (9+ months)")

#visit_clin <- ov_tab(jur_svyr, visited_clinic, "visited_clinic", "Visited health clinic in #past six months")

#hlth_rating <- ov_tab(filter(jur_svyr, !is.na(hlth_rating)), hlth_rating, "hlth_rating", #"Positive rating of health clinic visit")

hlth_rating2 <- ov_tab(jur_svyr, hlth_rating, "hlth_rating", "Positive rating of health clinic visit")

hlth <- bind_rows(list(meas, hlth_rating2))

#write_csv(hlth, here("output/tables/Jur River/health table Jur River.csv"))

hlth_flx <- hlth %>%
  select(`Indicator`=2, Number, Percent, `Confidence interval`=ci) %>%
  flextable() %>%
  set_formatter(Percent=function(x) sprintf("%.1f%%", x*100)) %>%
  width(j=4, width=1.4, unit="in") %>%
  width(j=1, width=2.6, unit="in") %>%
  align(align="center",
        part="header") %>%
  align(j=4,
        align="center") %>%
  add_footer_lines(values="Health indicators")

hlth_flx

#save_as_docx(hlth_flx, path=here("output/tables/Jur River/health table Jur River.docx"))


```

# Wau (Bahr el Gazal)
