---
title: "Shocks explore"
author: "Dan Killian"
date: "10/28/2021"
output: 
  bookdown::html_document2:
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float: true
    theme: paper
    fig.caption: true
    code_folding: hide
    df_print: kable
---

```{r global_options, include=F, warning=F, message=F, echo=F, error=F}
# standard figure size and generate clean output
knitr::opts_chunk$set(fig.height=4, fig.width=6, warning=FALSE, message=FALSE, cache=TRUE, error=T, echo=T)

library(here)

source(here("code/00 South Sudan resilience - prep.R"))

```


# Introduction

The South Sudan Monitoring and Evaluation Support Project (MESP) is conducting a household resilience survey in 13 counties. The purpose of this household survey is to obtain baseline data in the target areas for the indicators included in the Mission's Performance Management Plan (PMP) and the Community Roadmap, in support of USAID/South Sudan's Strategic Framework (2020-2024).

MESP has completed data collection in six counties, and as of October 2021 is carrying out data collection in the remaining seven counties. The study team is currently reviewing the data from six counties in advance of analysis of the full set of 13 counties. This document is one of a series of documents to review various measures and indices relating to resilience.

# Shocks and stressers

## Overall incidence of shocks

Unweighted

```{r}

# shck_mn <- dat %>%
#   select(shock_flood:shock_death) %>%
#   summarize_all(mean, na.rm=T) %>%
#   t() %>%
#   as.data.frame() %>%
#   rownames_to_column() %>%
#   set_names(nm=c("var_name","freq")) %>%
#   left_join(shock_key) %>%
#   select(1,3,4,2) %>%
#   arrange(desc(freq))
#   
# shck_mn

shck_mn_se <- dat %>%
  select(shock_flood:shock_death) %>%
  summarize(across(everything(),
                   list(mn = ~mean(.,na.rm=T), se = ~std.error(.,na.rm=T)))) %>%
#                   .names="{.col}.{.fn}")) %>% # name the separator from summarize
  pivot_longer(cols=1:32,
               names_to=c("discard", "var_name","measure"),
               names_sep="_",
               values_to="value") %>%
  select(-1) %>%
  pivot_wider(names_from=measure,
              values_from=value) %>%
  mutate(lower=mn-1.96*se,
         upper=mn+1.96*se,
         shock_lab=shock_labs,
         shock=1:16) %>%
  select(1,7,6, 2:5) %>%
  mutate(overall_rank = rank(-mn)) %>%
  arrange(desc(mn))

#write_csv(shck_mn_se, here("output/tables/shocks/shock incidence overall, unweighted.csv"))
  
shck_mn_se

```
```{r}

ggplot(shck_mn_se, aes(x=mn, y=fct_reorder(shock_lab, mn))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(labels=percent,
                     limits=c(0,1))

```

Weighted

```{r}

shck_svy <- svyrdat %>%
  select(shock_flood:shock_death) %>%
  summarize_all(survey_mean, na.rm=T) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  set_names(nm=c("var_name","freq"))

shck_mn_svy <- shck_svy %>%
  filter(row_number() %% 2 ==1) %>%
  rename(mn=freq) %>%
  mutate(shock_lab=shock_labs)

shck_se_svy <- shck_svy %>%
  filter(row_number() %% 2 == 0) %>%
  rename(se=freq) %>%
  mutate(shock_lab=shock_labs) %>%
  select(-1)

shck_mn_se_svy <- shck_mn_svy %>%
  left_join(shck_se_svy) %>%
  mutate(lower=mn-1.96*se,
         upper=mn+1.96*se) %>%
  select(1,3,2,4:6)

shck_mn_se_svy

```

```{r}

ggplot(shck_mn_se_svy, aes(x=mn, y=fct_reorder(shock_lab, mn))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(labels=percent,
                     limits=c(0,1))

```

## Incidence of shocks, by state

```{r}
shck_state_mn_se <- dat %>%
  select(state, shock_flood:shock_death) %>%
  group_by(state) %>%
  summarize(across(shock_flood:shock_death,
                   list(mn = ~mean(., na.rm=T), se = ~std.error(., na.rm=T)))) %>%
  pivot_longer(cols=2:33,
               names_to=c("discard", "var_name","measure"),
               names_sep="_",
               values_to="value") %>%
  select(-2) %>%
  pivot_wider(names_from=measure,
              values_from=value) %>%
  mutate(lower=mn-1.96*se,
         upper=mn+1.96*se) %>%
  cbind(shock_key) %>%
  select(1,2, 7,8,3:6) %>%
  group_by(state) %>%
  mutate(state_rank=rank(-mn)) %>%
  arrange(state,desc(mn)) %>%
  ungroup() 
  
#shck_state_mn_se

#write_csv(shck_state_mn_se, here("output/tables/shocks/shock incidence by state, unweighted.csv"))

```

```{r fig.height=7, fig.width=11}

ggplot(shck_state_mn_se, aes(x=mn, y=fct_reorder(shock_lab, mn))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(labels=percent,
                     limits=c(0,1)) +
  facet_wrap(~state) +
  faceted

```

## Incidence of shocks, by county

Unweighted

```{r}

shck_county_mn_se <- dat %>%
  select(state, county, shock_flood:shock_death) %>%
  group_by(state, county) %>%
  summarize(across(shock_flood:shock_death,
                   list(mn = ~mean(., na.rm=T), se = ~std.error(., na.rm=T)))) %>%
  pivot_longer(cols=3:34,
               names_to=c("discard", "var_name","measure"),
               names_sep="_",
               values_to="value") %>%
  select(-3) %>%
  pivot_wider(names_from=measure,
              values_from=value) %>%
  mutate(lower=mn-1.96*se,
         upper=mn+1.96*se) %>%
  ungroup() %>%
  mutate(shock_lab=rep(shock_labs,13)) %>%
  select(1,2, 3, 8, 4:7) %>%
  group_by(county) %>%
  mutate(county_rank=rank(-mn)) %>%
  arrange(county, desc(mn)) %>%
  ungroup() 
  
#shck_state_mn_se

#write_csv(shck_county_mn_se, here("output/tables/shocks/shock incidence by county, unweighted.csv"))

```

```{r fig.height=10, fig.width=11}

ggplot(shck_county_mn_se, aes(x=mn, y=fct_reorder(shock_lab, mn))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(labels=percent,
                     limits=c(0,1)) +
  facet_wrap(~state + county,
             ncol=5) +
  faceted

```

```{r}

shck_county_svy <- svyrdat %>%
  select(region, state, county, shock_flood:shock_death) %>%
  group_by(region, state, county) %>%
  summarize(across(shock_flood:shock_death,
                   list(mn = ~mean(., na.rm=T), se = ~std.error(., na.rm=T)))) %>%
  pivot_longer(cols=4:35,
               names_to=c("discard", "Shock","Measure"),
               names_sep="_",
               values_to="value") %>%
  select(-4) %>%
  pivot_wider(names_from=Measure,
              values_from=value) %>%
  mutate(lower=mn-1.96*se,
         upper=mn+1.96*se) %>%
  ungroup() %>%
  mutate(shock_lab=rep(shock_labs,9)) %>% # use 13 with full data
  select(1:4,9, 5:8) %>%
  group_by(county) %>%
  mutate(county_rank=rank(-mn)) %>%
  arrange(county, desc(mn)) %>%
  ungroup() 
  
shck_county_svy

#write_csv(shck_county_svy, here("output/tables/shocks/shock incidence by county, weighted.csv"))

```


## Shock clustering

```{r}
shocks <- dat %>%
  select(shock_flood:shock_death)

fa.parallel(shocks,
            cor="tet")
```
5 factors, 4 components 

```{r}
fa_shocks_5 <- fa(shocks,
                  nfactors=5,
                  cor="tet",
                  scores="tenBerge",
                  fm="ml")

fa_shocks_5
```
ML1: crop shocks

ML3: livestock shocks

ML2: land, erosion, flood

ML5: illness, death

ML4: food prices, illness

```{r}
fa_shocks_4 <- fa(shocks,
                  nfactors=4,
                  cor="tet",
                  scores="tenBerge",
                  fm="ml")

fa_shocks_4
```

ML2: Crop related

ML3: Erosion, loss of land, flood, food prices

ML1: Livestock related

ML4: Theft, illness, death

Explains 74 percent of the variance. Uninterpretable Tucker Lewis fit score and unacceptable RMSEA score (.6). 


## Shock severity

## Overall severity of shocks

Weighted

```{r}

# shck_mn <- dat %>%
#   select(shock_flood:shock_death) %>%
#   summarize_all(mean, na.rm=T) %>%
#   t() %>%
#   as.data.frame() %>%
#   rownames_to_column() %>%
#   set_names(nm=c("var_name","freq")) %>%
#   left_join(shock_key) %>%
#   select(1,3,4,2) %>%
#   arrange(desc(freq))
#   
# shck_mn

sev_mn_se <- dat %>%
  select(flood_severity:death_severity) %>%
  summarize(across(everything(),
                   list(mn = ~mean(.,na.rm=T), se = ~std.error(.,na.rm=T)))) %>%
  pivot_longer(cols=1:32,
               names_to=c("discard", "var_name","measure"),
               names_sep="_",
               values_to="value") %>%
#  select(-1) %>%
  pivot_wider(names_from=measure,
              values_from=value) %>%
  mutate(lower=mn-1.96*se,
         upper=mn+1.96*se,
         shock_lab=shock_labs,
         shock=1:16) %>%
  select(1,8, 7,3:6) %>%
  mutate(overall_rank = rank(-mn)) %>%
  arrange(desc(mn))

#write_csv(sev_mn_se, here("output/tables/shocks/shock severity overall, unweighted.csv"))
  
sev_mn_se

```

```{r}

ggplot(sev_mn_se, aes(x=mn, y=fct_reorder(shock_lab, mn))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(limits=c(0,8),
                     breaks=0:8)

```

Weighted

```{r}

sev_svy <- svyrdat %>%
  select(flood_severity:death_severity) %>%
  summarize_all(survey_mean, na.rm=T) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  set_names(nm=c("var_name","freq"))

sev_mn_svy <- sev_svy %>%
  filter(row_number() %% 2 ==1) %>%
  rename(mn=freq) %>%
  mutate(shock_lab=shock_labs)

sev_se_svy <- sev_svy %>%
  filter(row_number() %% 2 == 0) %>%
  rename(se=freq) %>%
  mutate(shock_lab=shock_labs) %>%
  select(-1)

sev_mn_se_svy <- sev_mn_svy %>%
  left_join(sev_se_svy) %>%
  mutate(lower=mn-1.96*se,
         upper=mn+1.96*se) %>%
  select(1,3,2,4:6)

sev_mn_se_svy

```

```{r}

ggplot(sev_mn_se_svy, aes(x=mn, y=fct_reorder(shock_lab, mn))) + 
  geom_vline(xintercept=c(4,6), size=1, linetype="dashed", color=dark_grey) +
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
#  geom_point(size=3, color=light_blue) +
  geom_label(aes(label=round(mn,1)), 
             color=medium_blue,
             label.padding=unit(.125, "lines")) +
  labs(x="",
       y="") + 
  scale_x_continuous(limits=c(0,8),
                     breaks=0:8) +
  annotate("text", x=5, y=6.5, label="Severe", color=dark_grey) +
  annotate("text", x=7, y=6.5, label="Extremely\nsevere", color=dark_grey)
# 
#   geom_rect(aes(xmin=4, xmax=6.5, ymin=0, ymax=16),
#             fill="salmon")

ggsave(here("output/viz/shocks/shock severity weighted.png"),
       device="png",
       type="cairo",
       height=4,
       width=7)

```



## Shock severity, by county

Weighted

```{r}

sev_cnty_svy <- svyrdat %>%
  select(region, state, county, flood_severity:death_severity) %>%
  group_by(region, state, county) %>%
  summarize(across(flood_severity:death_severity,
                   list(mn = ~mean(., na.rm=T), se = ~std.error(., na.rm=T)))) %>%
  pivot_longer(cols=4:35,
               names_to=c("Shock", "discard","Measure"),
               names_sep="_",
               values_to="value") %>%
  select(-5) %>%
  pivot_wider(names_from=Measure,
              values_from=value) %>%
  mutate(lower=mn-1.96*se,
         upper=mn+1.96*se) %>%
  ungroup() %>%
  mutate(shock_lab=rep(shock_labs,13)) %>% # use 13 with full data
  select(1:4,9, 5:8) %>%
  group_by(county) %>%
  mutate(county_rank=rank(-mn)) %>%
  arrange(county, desc(mn)) %>%
  ungroup() 
  
sev_cnty_svy

#write_csv(sev_cnty_svy, here("output/tables/shocks/shock severity by county, weighted.csv"))

```

Unweighted

```{r}

sev_county <- dat %>%
  select(region, state, county, flood_severity:death_severity) %>%
  group_by(region, state, county) %>%
  summarize(across(flood_severity:death_severity,
                   list(mn = ~mean(., na.rm=T), se = ~std.error(., na.rm=T)))) %>%
  pivot_longer(cols=4:35,
               names_to=c("var_name","discard", "measure"),
               names_sep="_",
               values_to="value") %>%
  select(-5) %>%
  pivot_wider(names_from=measure,
              values_from=value) %>%
  mutate(lower=mn-1.96*se,
         upper=mn+1.96*se) %>%
  ungroup() %>%
  mutate(shock_lab=rep(shock_labs,13)) %>%
  select(1:4, 9, 5:8) %>%
  group_by(county) %>%
  mutate(county_rank=rank(-mn)) %>%
  arrange(county, desc(mn)) %>%
  ungroup() 

sev_county

#write_csv(sev_county, here("output/tables/shocks/shock severity by county, unweighted.csv"))

```

```{r fig.height=10, fig.width=11}

ggplot(sev_county, aes(x=mn, y=fct_reorder(shock_lab, mn))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(limits=c(0,8),
                     breaks=0:8) +
  facet_wrap(~region + state + county,
             ncol=5) +
  faceted

```

## Shock clustering, weighted by severity

```{r}
sev <- dat %>%
  select(flood_severity:death_severity)

fa.parallel(sev)
```
5 factors, 3 components

```{r}
fa_sev_5 <- fa(sev,
                  nfactors=5,
                  scores="tenBerge",
                  fm="ml")

fa_sev_5
```

ML2: crop disease, crop pests, ag inputs, crop theft

ML1: Livestock input, livestock disease, unable to sell, livestock theft

ML3: Erosion, loss of land, flood, food prices

ML5: Illness and death

ML4: Theft

Explains 63 percent of the variance. Fit statistics sufficient (Tucker Lewis .98, RMSEA .044)

```{r}
fa_sev_5_scores <- fa_sev_5$scores %>%
  as.data.frame() %>%
  set_names(nm=c("shock_sev_crops", "shock_sev_livestock","shock_sev_drought", "shock_sev_illdeath", "shock_sev_theft"))

#head(fa_sev_5_scores)
describe(fa_sev_5_scores)

```

```{r}
dat <- dat %>%
  mutate(shock_sev_crops=fa_sev_5_scores$shock_sev_crops,
         shock_sev_livestock = fa_sev_5_scores$shock_sev_livestock,
         shock_sev_drought=fa_sev_5_scores$shock_sev_drought,
         shock_sev_illdeath = fa_sev_5_scores$shock_sev_illdeath,
         shock_sev_theft = fa_sev_5_scores$shock_sev_theft,)

ggplot(dat) + 
  geom_density(aes(shock_sev_livestock), color=usaid_red) + 
  geom_density(aes(shock_sev_crops), color=usaid_blue) +
  geom_density(aes(shock_sev_drought), color=light_blue)

```



```{r}
fa_sev_4 <- fa(sev,
                  nfactors=4,
                  scores="tenBerge",
                  fm="ml")

fa_sev_4
```
ML1: livestock, inability to sell, illness and death

ML2: crop related

ML3: erosion, loss of land, flood, food prices

ML4: theft

Explains 59 percent of variance. Fit statistics sufficient (Tucker Lewis .95, RMSEA .06). 

```{r}
fa_sev_3 <- fa(sev,
                  nfactors=3,
                  scores="tenBerge",
                  fm="ml")

fa_sev_3
```
ML2: livestock, inability sell, illness and death

ML1: crop related

ML3: erosion, loss of land, flood, food prices

Explains 56 percent of the variance. Acceptable Tucker Lewis fit score (.92). RMSEA score of .08 is a little high but probably acceptable. 

```{r}
fa_sev_3_scores <- fa_sev_3$scores %>%
  as.data.frame() %>%
  set_names(nm=c("shock_sev_livestock", "shock_sev_crops","shocks_sev_drought"))

head(fa_sev_3_scores)
describe(fa_sev_3_scores)

```
```{r}
# dat <- dat %>%
#   mutate(shock_sev_livestock=fa_sev_3_scores$shock_sev_livestock,
#          shock_sev_crops = fa_sev_3_scores$shock_sev_crops,
#          shock_sev_drought=fa_sev_3_scores$shocks_sev_drought)

ggplot(dat, aes(y=shock_exposure_index)) + 
  stat_smooth(aes(shock_sev_livestock), se=F, color=usaid_red) + 
  stat_smooth(aes(shock_sev_crops), se=F, color=usaid_blue) +
  stat_smooth(aes(shock_sev_drought), se=F, color=light_blue)

```

## Shock exposure

```{r}
exposure_mn <- svyrdat %>%
  #group_by() %>%
  summarize(#exposure=survey_mean(shock_exposure_index),
            exposure_med=survey_median(shock_exposure_index)) 
%>%
  mutate(lower=exposure-1.96*exposure_se,
         upper=exposure+1.96*exposure_se)

exposure_mn

svyrdat %>%
  summarize(a = survey_quantile(shock_exposure_index)) 
              
              survey_median(shock_exposure_index))
            ,
                              vartype=c("ci")))

median(dat$shock_exposure_index)

```


```{r}
ggplot(dat, aes(shock_exposure_index, weights=final_wt1)) + 
#  geom_vline(xintercept=c(46.9, 51.6), linetype="dotdash", size=.5, alpha=.6) +
  geom_vline(xintercept=64, color=medium_grey, linetype="dotdash", size=1, alpha=.6) +
  annotate("text", x=75, y=.0035, label="Severe\nexposure", color=dark_grey) +
  geom_vline(xintercept=49.2, size=1.5, color="darkgoldenrod2", alpha=.6) + 
  geom_density(color=medium_blue, fill=light_blue, alpha=.4) +
  scale_x_continuous(limits=c(0,128),
                     breaks=seq(0,120,10)) +
  labs(x="",
       y="") +
  theme(axis.text.y=element_blank())

ggsave(here("output/viz/shocks/shock index weighted.png"),
       device="png",
       type="cairo",
       height=3,
       width=6)

```
```{r}
ggplot(dat, aes(shock_exposure_index, weights=final_wt1)) +
  geom_bar()
```

```{r}
ggplot(dat, aes(shock_exposure_index, weights=final_wt1)) + 
  geom_vline(xintercept=0, color=medium_grey, size=1, alpha=.5) +
  #geom_vline(xintercept=40, color="darkgoldenrod3", size=2) +
  geom_density_ridges(aes(y=region),
                      scale=.9,
                      color=medium_blue,
                      fill=light_blue,
                      alpha=.8,
                      quantile_lines = TRUE,
                      quantiles=2) +
                      #jittered_points = TRUE,
                      #position = position_points_jitter(width = 0, height = 0),
                      #point_shape = '|', point_size = 1, point_alpha = 1, alpha = 0.7) +
  scale_x_continuous(limits=c(0,128),
                     breaks=seq(0,125,25)) +
  labs(x="",
       y="")

ggsave(here("output/viz/shocks/shock exposure region weighted.png"),
       type="cairo",
       device="png",
       height=3,
       width=5)
```

```{r}

ggplot(dat, aes(shock_exposure_index, weights=final_wt1)) + 
  stat_halfeye(.width=c(0,0), fill=medium_blue, alpha=.6) +
  geom_linerangeh(aes(xmin=46.9, xmax=51.6, y=.1)) +
  scale_x_continuous(limits=c(0,128),
                     breaks=seq(0,128,25))


```


```{r}
ltm_shck <- ltm(shocks ~ z1)
ltm_shck
```

```{r}
shock_facs <- dat %>%
  select(shock_sev_crops,
         shock_sev_livestock,
         shock_sev_drought,
         shock_sev_illdeath,
         shock_sev_theft)

fa.parallel(shock_facs)
```

```{r}
prin_shock_facs <- principal(shock_facs)
prin_shock_facs
```

```{r}
prin_shock_facs_scrs <- prin_shock_facs$scores %>%
  as.data.frame()

dat <- dat %>%
  mutate(shock_facs_comp=prin_shock_facs_scrs$PC1)

ggplot(dat, aes(shock_facs_comp)) + 
  geom_density()

```



```{r}
prin_sev <- principal(sev)
prin_sev
```

```{r}

prin_sev_scrs <- prin_sev$scores %>%
  as.data.frame()

#str(prin_sev_scrs)

dat <- dat %>%
  mutate(shock_exposure_comp = prin_sev_scrs$PC1)

ggplot(dat, aes(shock_exposure_comp)) + 
  geom_density()

```
```{r}
ggplot(dat, aes(shock_exposure_index, shock_facs_comp)) + 
  geom_point(color=light_blue, size=.7) + 
  stat_smooth()
```

# Dietary diversity 

```{r}

diet <- dat %>%
  select(q_403:q_404,
         vegetable:meat,
         q_413:q_419)

map(diet, frq)
```

```{r}
ltm_diet <- ltm(diet ~ z1)
ltm_diet
```

```{r}
plot(ltm_diet, type="ICC")
```

```{r}
plot(ltm_diet, type="IIC")
```

```{r}
plot(ltm_diet, 
     type="IIC",
     items=0)
```

```{r}
prin_diet <- principal(diet,
                       cor="tet")
prin_diet
```

```{r}
prin_diet_scrs <- prin_diet$scores %>%
  as.data.frame()

dat <- dat %>%
  mutate(hdds_comp=prin_diet_scrs$PC1)

ggplot(dat, aes(hdds_comp)) +
  geom_density()

```

```{r}
ggplot(dat, aes(hdds, hdds_comp)) + 
  geom_point(color=light_blue, size=.8) + 
  stat_smooth() + 
  scale_x_continuous(breaks=1:12)
```


```{r}

ggplot(geduc_cnty, aes(geduc, fct_reorder(county, geduc))) + 
  geom_vline(aes(xintercept=geduc_mn), color="darkgoldenrod2", size=1, alpha=.8) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), color=medium_blue, width=0) + 
  geom_label(aes(label=round(geduc,2)), color=medium_blue, size=3) + 
  scale_x_continuous(limits=c(-.75,.75),
                     breaks=seq(-1,1,.25)) + 
  labs(x="",
       y="")

# ggsave(here("output/viz/girls education/geduc by county.png"),
#        device="png",
#        type="cairo",
#        height=5,
#        width=7)


```

```{r}
ggplot(dat, aes(shock_exposure_index)) + 
  #geom_bar() + 
  geom_density(color=light_blue) +
  facet_wrap(~state) +
  faceted
```

```{r}
ggplot(dat, aes(shock_exposure_index)) + 
  #geom_bar() + 
  geom_density(color=light_blue) +
  facet_wrap(~county) +
  faceted
```


```{r}
expos <- dat %>%
  group_by(region, state, county) %>%
  summarize(exposure=mean(shock_exposure_index, na.rm=T),
            se=std.error(shock_exposure_index, na.rm=T)) %>%
  mutate(lower=exposure-1.96*se,
         upper=exposure+1.96*se)

expos
```
Unweighted

```{r}
ggplot(expos, aes(x=exposure, y=fct_reorder(county, exposure))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(limits=c(0,128),
                     breaks=seq(0,125,25)) 

```

```{r fig.height=10, fig.width=9}
ggplot(expos, aes(x=exposure, y=fct_reorder(county, exposure))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(limits=c(0,128),
                     breaks=seq(0,125,25)) +
  facet_wrap(~state,
             scales="free",
             ncol=2) + 
  faceted

```

Weighted

```{r}
expos_wt <- svyrdat %>%
  group_by(county) %>%
  summarize(exposure=survey_mean(shock_exposure_index, na.rm=T)) %>%
  mutate(lower=exposure-1.96*exposure_se,
         upper=exposure+1.96*exposure_se)

expos_wt

write_csv(expos_wt, here("output/tables/shock exposure by county weighted.csv"))
```

```{r}
ggplot(expos_wt, aes(x=exposure, y=fct_reorder(county, exposure))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=medium_blue) +
  geom_point(size=3, color=light_blue) +
  geom_label(aes(label=round(exposure,0)), 
             color=medium_blue, 
             size=3,
             label.padding=unit(.2, "lines")) +
  labs(x="",
       y="") + 
  scale_x_continuous(limits=c(0,128),
                     breaks=seq(0,125,25)) 

ggsave(here("output/viz/shocks/shock exposure by county weighted.png"),
       device="png",
       type="cairo",
       height=4,
       width=6)
```

```{r}
s1 <- stan_glmer(shock_exposure_index ~ (1|county),
                 cores=8,
                 data=dat)

summary(s1, digits=3)
```

```{r}
s1_out <- s1 %>%
  as.data.frame() %>%
  set_names(nm=c("Intercept", county_labs2, "sigma", "county_sigma"))
head(s1_out)
```

```{r}
s1L <- s1_out %>%
  pivot_longer(cols=2:10,
               values_to = "exposure_dev",
               names_to = "County") %>%
  mutate(Exposure = Intercept + exposure_dev)

head(s1L)

```

```{r}
cnty_mns <- s1L %>%
  group_by(County) %>%
  summarize(Exposure=mean(Exposure))
cnty_mns
```

```{r}

ggplot(s1L, aes(Exposure, fct_reorder(County, Exposure))) + 
  geom_vline(xintercept=0, color="darkgrey", size=1, alpha=.6) +
  geom_vline(xintercept=47.3, color="darkgoldenrod2", size=1, alpha=.8, linetype="dashed") +
  stat_halfeye(fill="cadetblue2",color="blue", alpha=.7) +
  scale_x_continuous(limits=c(0,80),
                     breaks=seq(0,80,20)) +
  labs(x="Shock exposure",
       y="") 
#  geom_label(data=cnty_mns, aes(label=round(Exposure,0), x=Exposure), 
#             color="blue",
#             label.padding = unit(.2, "lines"))

ggsave("viz/2021-1/loans/loan timeliness, by office (13 Oct 2021).png",
       device="png",
       type="cairo",
       height=4,
       width=7)

```

```{r}

```


# Ability to recover

```{r}
frq(dat$ability_recover)
```



```{r}

```

```{r}

arssi_mn <- svyrdat %>%
  group_by() %>%
  summarize(arssi=survey_mean(arssi, na.rm=T)) %>%
  mutate(lower=arssi - 1.96*arssi_se,
         upper=arssi + 1.96*arssi_se,
         measure="")

arssi_mn # 7.58

```

```{r}

arssi_cat <- svyrdat %>%
  group_by(ability_recover) %>%
  summarize(arssi=survey_mean()) %>%
  mutate(lower=arssi - 1.96*arssi_se,
         upper=arssi + 1.96*arssi_se,
         measure="")

  select(1) %>%
  unlist()

arssi_cat # 7.58

```


```{r}
ggplot(arssi_mn, aes(arssi, measure)) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, color=medium_blue) +
  #geom_hline(yintercept=1, color=light_blue, size=1) +
  geom_segment(aes(x=1.9, xend=6.2, y=1, yend=1), color=light_blue) + 
  geom_label(aes(label=round(arssi,1)), color=medium_blue, size=6) +
  scale_x_continuous(limits=c(1.9, 6.2),
                     breaks=2:6) +
  labs(x="",
       y="") 


ggsave(here("output/viz/shocks/arssi weighted.png"),
       device="png",
       type="cairo",
       height=1.2,
       width=3)

```

```{r}
ggplot(fies_mn, aes(fies, measure)) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, color=medium_blue) +
  #geom_hline(yintercept=1, color=light_blue, size=1) +
  geom_segment(aes(x=0, xend=8, y=1, yend=1), color=light_blue) + 
  geom_label(aes(label=round(fies,1)), color=medium_blue, size=8) +
  scale_x_continuous(limits=c(0,8),
                     breaks=0:8) +
  labs(x="",
       y="") +
  geom_ribbon(aes(xmin=1, xmax=3))

ggsave(here("output/viz/shocks/fies overall weighted.png"),
       device="png",
       type="cairo",
       height=1.2,
       width=4)

```


```{r}
arssi1 <- svyrdat %>%
  group_by(rc_q_488) %>%
  summarize(Response=survey_mean()) %>%
  na.omit() %>%
  select(2) %>%
  mutate(Category =c("Worse than before", "Same as before","Better than before"),
         Item = "Current ability to meet food needs") %>%
  select(3, 2,1)

arssi1

arssi2 <- svyrdat %>%
  group_by(rc_q_489) %>%
  summarize(Response=survey_mean()) %>%
  na.omit() %>%
  select(2) %>%
  mutate(Category =c("Worse than before", "Same as before","Better than before"),
         Item = "Future ability to meet food needs") %>%
  select(3,2,1)

arssi2

```

```{r}

arssi <- arssi1 %>%
  rbind(arssi2) %>%
  mutate(Score=rep(1:3,2)) 
  #relocate(Score, .after=Category)

arssi

arssi_gt <- arssi %>%
  gt() %>%
  fmt_percent(3,
              decimals=1)

arssi_gt

gtsave(arssi_gt, here("output/tables/shocks/arssi weighted.rtf"))

```


```{r}
rec_county <- dat %>%
  group_by(region, state, county) %>%
  summarize(rec = mean(ability_recover, na.rm=T),
            se = std.error(ability_recover, na.rm=T)) %>%
  arrange(desc(rec))  %>%
  mutate(lower=rec-1.96*se,
         upper=rec+1.96*se)

rec_county
```
```{r fig.height=8, fig.width=8}

ggplot(rec_county, aes(x=rec, y=fct_reorder(county, rec))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(limits=c(2,6),
                     breaks=2:6)

+
  facet_wrap(~region + state,
             ncol=5,
             scales="free") +
  faceted

```

```{r}
rec_lang <- dat %>%
  group_by(q_211) %>%
  summarize(rec = mean(ability_recover, na.rm=T),
            se = std.error(ability_recover, na.rm=T)) %>%
  arrange(desc(rec))  %>%
  mutate(lower=rec-1.96*se,
         upper=rec+1.96*se)

rec_lang
```



```{r}
ggplot(rec_lang, aes(x=rec, y=reorder(as.numeric(q_211), rec))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(limits=c(2,6),
                     breaks=2:6)

+
  facet_wrap(~region + state,
             ncol=5,
             scales="free") +
  faceted
```


## ARSSI

Exploration of indicator table presentation

```{r}
frq(dat$arssi)
```


```{r}

arssi_mn <- svyrdat %>%
  group_by() %>%
  summarize(Value=survey_mean(arssi, na.rm=T)) %>%
  mutate(Lower=Value-Value_se*1.96,
         Upper=Value+Value_se*1.96,
         Disaggregate="Overall",
         `Disaggregate type`="Overall") %>%
  select(5,6,1,3:4)

arssi_mn

```

```{r}

arssi_reg <- svyrdat %>%
  group_by(`Disaggregate type`=region) %>%
  summarize(Value=survey_mean(arssi, na.rm=T)) %>%
  mutate(Lower=Value-Value_se*1.96,
         Upper=Value+Value_se*1.96,
         Disaggregate="Region") %>%
  select(6,1,2,4:5)

arssi_reg

```

```{r}

arssi_state <- svyrdat %>%
  group_by(`Disaggregate type`=state) %>%
  summarize(Value=survey_mean(arssi, na.rm=T)) %>%
  mutate(Lower=Value-Value_se*1.96,
         Upper=Value+Value_se*1.96,
         Disaggregate="State") %>%
  select(6, 1, 2, 4:5)

arssi_state

```

```{r}

arssi_county <- svyrdat %>%
  group_by(`Disaggregate type`=county) %>%
#  group_by(Region=region, State=state, County=county) %>%
  summarize(Value=survey_mean(arssi, na.rm=T)) %>%
  mutate(Lower=Value-Value_se*1.96,
         Upper=Value+Value_se*1.96,
         Disaggregate="County") %>%
  select(6,1,2,4:5)

arssi_county

```

```{r}
ind_arssi <- do.call(rbind, list(arssi_mn,
                                 arssi_reg,
                                 arssi_state,
                                 arssi_county))

#ind_arssi

#write_csv(ind_arssi, here("output/tables/shocks/indicator - arssi.csv"))

ind_arssi_gt <- ind_arssi %>%
  gt() %>%
  tab_source_note(source_note="Ability to recover from shocks and stresses")

ind_arssi_gt

#gtsave(ind_arssi_gt, here("output/tables/shocks/indicator 26 - arssi.rtf"))

```


# Food security and shocks

```{r}
l1 <- lm(fies_raw ~ shock_exposure_index,
         data=dat)

summary(l1) # se .000715
```

```{r}
surv1 <- svyglm(fies_raw ~ shock_exposure_index,
                design=svydat)
summary(surv1) # se .00159
```
```{r}
.000715/.00159

.00159/.000715

.000715*2.22

```

They survey weighted error is 2.2 times the unweighted error. How does this compare to a Bayesian multilevel model? 

```{r}
s1_fies <- stan_glm(fies_raw ~ shock_exposure_index,
                      chains=8,
                      cores=8,
                      data=dat)

summary(s1_fies, digits=5) # se .00071
```
```{r}
s2_fies <- stan_glmer(fies_raw ~ shock_exposure_index + (1|county/ea),
                      chains=8,
                      cores=8,
                      data=dat)

summary(s2_fies, digits=5) # se .00085
```


```{r}
l2 <- lm(fies_raw ~ shock_sev_livestock + shock_sev_crops + shock_sev_drought,
         data=dat)

summary(l2)
```

```{r}
ggplot(dat, aes(x=shock_sev_drought, y=fies_raw)) + 
  geom_point(size=.5, alpha=.3, color=light_blue) + 
  stat_smooth(color=light_blue)
```

```{r}
ggplot(dat, aes(x=shock_sev_drought, y=fies_raw)) + 
  stat_smooth(color=light_blue, se=F) + 
  stat_smooth(aes(shock_sev_livestock), color=usaid_red, se=F) + 
  stat_smooth(aes(shock_sev_crops), color=usaid_blue, se=F) + 
  scale_x_continuous(limits=c(-2,2)) + 
  scale_y_continuous(limits=c(4,8),
                     breaks=1:8)
```

```{r}
ggplot(dat, aes(x=shock_sev_drought, y=fies_raw)) + 
  geom_point(size=.5, alpha=.3, color=light_blue) + 
  stat_smooth(color=light_blue)
```





```{r}
ggplot(dat, aes(x=shock_drought, y=fies_raw)) + 
  geom_point(size=.5, alpha=.3, color=light_blue) + 
  stat_smooth(color=light_blue,
              method="lm")
```

```{r}

surv2 <- svyglm(fies_raw ~ shock_exposure_index + donor_act,
                design=svydat)
summary(surv2) 
```

```{r}
ins_surv3 <- svyglm(fies_raw ~ shock_exposure_index + donor_act + as.factor(county),
                design=svydat)
summary(ins_surv3) 
```

```{r}
ins_surv4 <- svyglm(fies_raw ~ shock_exposure_index + hdds + donor_act + as.factor(county),
                design=svydat)
summary(ins_surv4) 
```

```{r}
ins_surv5 <- svyglm(fies_raw ~ shock_exposure_index + hdds + donor_act + 
                      bonding_capital_raw +
                      as.factor(county),
                design=svydat)
summary(ins_surv5) 
```
```{r}
ins_surv6 <- svyglm(fies_raw ~ shock_exposure_index + hdds + donor_act + 
                      bonding_capital_raw +
                      bridging_capital_raw +
                      as.factor(county),
                design=svydat)
summary(ins_surv6) 
```

```{r}
ins_surv7 <- svyglm(fies_raw ~ shock_exposure_index + hdds + donor_act + 
                      bonding_capital_raw +
                      bridging_capital_raw +
                      aspirations_index +
                      as.factor(county),
                design=svydat)
summary(ins_surv7) 
```
```{r}
ins_surv8 <- svyglm(fies_raw ~ shock_exposure_index + hdds + donor_act + 
                      bonding_capital_raw +
                      bridging_capital_raw +
                      aspirations_index +
                      grp_participate +
                      as.factor(county),
                design=svydat)
summary(ins_surv8) 
```
```{r}
ins_surv9 <- svyglm(fies_raw ~ shock_exposure_index + hdds + donor_act + 
                      bonding_capital_raw +
                      bridging_capital_raw +
                      aspirations_index +
                      grp_participate +
                      ews_participate +
                      as.factor(county),
                design=svydat)
summary(ins_surv9) 
```

```{r}
ins_surv10 <- svyglm(fies_raw ~ shock_exposure_index + hdds + donor_act + 
                      bonding_capital_raw +
                      bridging_capital_raw +
                      aspirations_index +
                      grp_participate +
                      warn_sum +
                      as.factor(county),
                design=svydat)
summary(ins_surv10) 
```
```{r}
ins_surv11 <- svyglm(fies_raw ~ shock_exposure_index + hdds + donor_act + 
                      bonding_capital_raw +
                      bridging_capital_raw +
                      aspirations_index +
                      grp_participate +
                      ews_participate +
                      emerg_plan + 
                      as.factor(county),
                design=svydat)
summary(ins_surv11) 
```

```{r}
ins_surv12 <- svyglm(fies_raw ~ shock_exposure_index + hdds + donor_act + 
                      bonding_capital_raw +
                      bridging_capital_raw +
                      aspirations_index +
                      grp_participate +
                      ews_participate +
                      emerg_plan +
                      conflict +
                      as.factor(county),
                design=svydat)
summary(ins_surv12) 
```

# Conflict

```{r}
frq(dat$q_601)
```

```{r}

conflict_mn <- svyrdat %>%
  group_by() %>%
  summarize(conflict=survey_mean(q_601, na.rm=T)) %>%
  mutate(lower=conflict - 1.96*conflict_se,
         upper=conflict + 1.96*conflict_se,
         measure="")

conflict_mn # 7.58

```

```{r}
ggplot(conflict_mn, aes(conflict, measure)) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, color=medium_blue) +
  #geom_hline(yintercept=1, color=light_blue, size=1) +
  geom_segment(aes(x=0, xend=1, y=1, yend=1), color=light_blue) + 
  geom_label(aes(label=paste(round(conflict,3)*100, "%", sep="")), color=medium_blue, size=5) +
  scale_x_continuous(limits=c(0,1),
                     breaks=seq(0,1,.2),
                     labels=percent) +
  labs(x="Incidence of conflict",
       y="") 


ggsave(here("output/viz/shocks/conflict weighted.png"),
       device="png",
       type="cairo",
       height=1.2,
       width=3.7)

```


```{r}
frq(dat$q_601)
frq(dat$q_602_1)

conf_temp <- svyrdat %>%
  summarize(conf_land = survey_mean(q_602_1, na.rm=T),
            conf_water = survey_mean(q_602_2, na.rm=T),
            conf_pasture = survey_mean(q_602_3, na.rm=T),
            conf_forestry = survey_mean(q_602_4, na.rm=T),
            conf_cattle = survey_mean(q_602_5, na.rm=T),
            conf_goat = survey_mean(q_602_6, na.rm=T),
            conf_migration = survey_mean(q_602_7, na.rm=T),
            conf_boundary = survey_mean(q_602_8, na.rm=T),
            conf_revenge = survey_mean(q_602_9, na.rm=T),
            conf_dowry = survey_mean(q_602_10, na.rm=T),
            conf_elope = survey_mean(q_602_11, na.rm=T),
            conf_raid = survey_mean(q_602_12, na.rm=T),
            conf_fishing = survey_mean(q_602_13, na.rm=T),
            conf_gbv = survey_mean(q_602_14, na.rm=T),
            conf_livelihood = survey_mean(q_602_15, na.rm=T),
            conf_ag = survey_mean(q_602_16, na.rm=T))

conf_temp
```

```{r}
conf_types_mn <- conf_temp %>%
  select(!contains("se")) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("conflict") %>%
  rename(percent=V1)

conf_types_mn

conf_types_se <- conf_temp %>%
  select(contains("se")) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("conflict") %>%
  rename(se=V1)

conf_types_se

conf_types <- conf_types_mn %>%
  cbind(conf_types_se[,2]) %>%
  rename(se=3) %>%
  mutate(lower=percent-1.96*se,
         upper=percent+1.96*se,
         conf_lab=conf_labs) %>%
  select(1,6,everything()) %>%
  arrange(desc(percent))


conf_types

```

```{r}
ggplot(conf_types, aes(x=percent, y=fct_reorder(conf_lab, percent))) + 
#  geom_point() + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=medium_blue, ) + 
  geom_label(aes(label=paste(round(percent,2)*100, "%", sep="")), 
             size=5, color="white", fill=medium_blue, label.padding = unit(.17, "lines")) +
  scale_x_continuous(labels=percent,
                     limits=c(0,1),
                     breaks=seq(0,1,.2)) + 
  labs(x="",
       y="")

ggsave(here("output/viz/conflicts weighted.png"),
       device="png",
       type="cairo",
       height=5,
       width=7)
```


## by county

```{r}
frq(dat$q_601)
frq(dat$q_602_1)

conf_cnty_temp <- svyrdat %>%
  group_by(region, state, county) %>%
  summarize(conf_land = survey_mean(q_602_1, na.rm=T),
            conf_water = survey_mean(q_602_2, na.rm=T),
            conf_pasture = survey_mean(q_602_3, na.rm=T),
            conf_forestry = survey_mean(q_602_4, na.rm=T),
            conf_cattle = survey_mean(q_602_5, na.rm=T),
            conf_goat = survey_mean(q_602_6, na.rm=T),
            conf_migration = survey_mean(q_602_7, na.rm=T),
            conf_boundary = survey_mean(q_602_8, na.rm=T),
            conf_revenge = survey_mean(q_602_9, na.rm=T),
            conf_dowry = survey_mean(q_602_10, na.rm=T),
            conf_elope = survey_mean(q_602_11, na.rm=T),
            conf_raid = survey_mean(q_602_12, na.rm=T),
            conf_fishing = survey_mean(q_602_13, na.rm=T),
            conf_gbv = survey_mean(q_602_14, na.rm=T),
            conf_livelihood = survey_mean(q_602_15, na.rm=T),
            conf_ag = survey_mean(q_602_16, na.rm=T))

conf_cnty_temp
```

```{r}
conf_cnty_types_mn <- conf_cnty_temp %>%
  select(!contains("se")) %>%
  melt() %>%
  mutate(conf_lab=rep(conf_labs,each=13)) %>%
  rename(percent=value)


conf_cnty_types_mn


conf_cnty_types_se <- conf_cnty_temp %>%
  select(county, 
         contains("se")) %>%
  melt() %>%
  rename(se=value,
         se_var=variable)

conf_cnty_types_se

conf_cnty_types <- conf_cnty_types_mn %>%
  cbind(conf_cnty_types_se[,5]) %>%
  select(1:3, 4,6,5,se=7) %>%
  arrange(county, desc(percent))


write_csv(conf_cnty_types, here("output/tables/shocks/conflict types by county weighted.csv"))

```



























