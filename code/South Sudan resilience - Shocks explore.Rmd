---
title: "Shocks explore"
author: "Dan Killian"
date: "10/28/2021"
output: 
  bookdown::html_document2:
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float: true
    theme: paper
    fig.caption: true
    code_folding: hide
    df_print: kable
---

```{r global_options, include=F, warning=F, message=F, echo=F, error=F}
# standard figure size and generate clean output
knitr::opts_chunk$set(fig.height=4, fig.width=6, warning=FALSE, message=FALSE, cache=TRUE, error=T, echo=T)

library(here)

knitr::opts_knit$set(root.dir=here()) # doesn't seem to work

source(here("code/00 South Sudan resilience - prep.R"))

#dat <- read_dta(here("data/local/SSD resilience baseline prepared.dta"))

dat <- read_dta(here("data/local/SSD resilience baseline prepared (9 Nov 2021).dta"))

# frq_disag <- function(object, disaggregate, item, label, media) {
#   temp <- object %>%
#     group_by({{disaggregate}}) %>%
#     summarize(Percent=mean({{item}}, na.rm=T),
#               se=std.error({{item}}, na.rm=T)) %>%
#     mutate(var_name={{label}},
#            Media={{media}},
#            lower=Percent-1.96*se,
#            upper=Percent+1.96*se)
#   temp
# }

svy_disag <- function(design, disaggregate, item, label) {
  temp <- design %>%
    group_by({{disaggregate}}) %>%
    summarize(Value=survey_mean({{item}}, na.rm=T)) %>%
    mutate(item={{item}},
           label={{label}},
           lower=Value-1.96*se,
           upper=Value+1.96*se)
  temp
}


# svyrdat <- dat %>%
#   as_survey_design(ids = ea,
#                    strata=county,
#                    weights=final_wt1)
```


# Introduction

The South Sudan Monitoring and Evaluation Support Project (MESP) is conducting a household resilience survey in 13 counties. The purpose of this household survey is to obtain baseline data in the target areas for the indicators included in the Mission's Performance Management Plan (PMP) and the Community Roadmap, in support of USAID/South Sudan's Strategic Framework (2020-2024).

MESP has completed data collection in six counties, and as of October 2021 is carrying out data collection in the remaining seven counties. The study team is currently reviewing the data from six counties in advance of analysis of the full set of 13 counties. This document is one of a series of documents to review various measures and indices relating to resilience.

# Shocks and stressers

```{r}

#frq(dat$q_439)
#map(dat[,163:211], frq)

```


```{r}

#frq(dat$q_436)
#frq(dat$flood_severity)

dat <- dat %>%
  mutate(shock_flood = ifelse(is.na(q_436), 0,q_436),
         #flood_ec = q_437,
         #flood_cons = q_438,
         shock_drought = ifelse(is.na(q_439), 0, q_439),
         #drought_ec = q_440,
         #drought_cons = q_441,
         shock_erosion = ifelse(is.na(q_442), 0, q_442),
         shock_lostland = ifelse(is.na(q_445), 0, q_445),
         shock_foodprice = ifelse(is.na(q_448), 0, q_448),
         shock_theft = ifelse(is.na(q_451), 0, q_451),
         shock_cropinputs = ifelse(is.na(q_455), 0, q_455),
         shock_cropdisease = ifelse(is.na(q_458), 0, q_458),
         shock_croppests = ifelse(is.na(q_461), 0, q_461),
         shock_croptheft = ifelse(is.na(q_464), 0, q_464),
         shock_livestockinputs = ifelse(is.na(q_468), 0, q_468),
         shock_livestockdisease = ifelse(is.na(q_471), 0, q_471),
         shock_livestocktheft = ifelse(is.na(q_474), 0, q_474),
         #shock_nosell = ifelse(is.na(q_477), 0, q_477),
         #shock_illness = ifelse(is.na(q_480), 0, q_480),
         #shock_death = ifelse(is.na(q_484), 0, q_484),
         shock_nosell = q_477,
         shock_illness = q_480,
         shock_death = q_484,
         shocks = shock_flood + 
           shock_drought + 
           shock_erosion + 
           shock_lostland + 
           shock_foodprice + 
           shock_theft + 
           shock_cropinputs + 
           shock_cropdisease + 
           shock_croppests + 
           shock_croptheft + 
           shock_livestockinputs + 
           shock_livestockdisease + 
           shock_livestocktheft + 
           shock_nosell + 
           shock_illness + 
           shock_death)

```


```{r}

dat_wt <- dat_wt %>%
  mutate(shock_flood = ifelse(is.na(q_436), 0,q_436),
         #flood_ec = q_437,
         #flood_cons = q_438,
         shock_drought = ifelse(is.na(q_439), 0, q_439),
         #drought_ec = q_440,
         #drought_cons = q_441,
         shock_erosion = ifelse(is.na(q_442), 0, q_442),
         shock_lostland = ifelse(is.na(q_445), 0, q_445),
         shock_foodprice = ifelse(is.na(q_448), 0, q_448),
         shock_theft = ifelse(is.na(q_451), 0, q_451),
         shock_cropinputs = ifelse(is.na(q_455), 0, q_455),
         shock_cropdisease = ifelse(is.na(q_458), 0, q_458),
         shock_croppests = ifelse(is.na(q_461), 0, q_461),
         shock_croptheft = ifelse(is.na(q_464), 0, q_464),
         shock_livestockinputs = ifelse(is.na(q_468), 0, q_468),
         shock_livestockdisease = ifelse(is.na(q_471), 0, q_471),
         shock_livestocktheft = ifelse(is.na(q_474), 0, q_474),
         #shock_nosell = ifelse(is.na(q_477), 0, q_477),
         #shock_illness = ifelse(is.na(q_480), 0, q_480),
         #shock_death = ifelse(is.na(q_484), 0, q_484),
         shock_nosell = q_477,
         shock_illness = q_480,
         shock_death = q_484,
         shocks = shock_flood + 
           shock_drought + 
           shock_erosion + 
           shock_lostland + 
           shock_foodprice + 
           shock_theft + 
           shock_cropinputs + 
           shock_cropdisease + 
           shock_croppests + 
           shock_croptheft + 
           shock_livestockinputs + 
           shock_livestockdisease + 
           shock_livestocktheft + 
           shock_nosell + 
           shock_illness + 
           shock_death)

svydat <- svydesign(data = dat_wt,
                     ids = ~ea,
                     weights= ~final_wt1,
                     strata = ~county)

svyrdat <- dat_wt %>%
   as_survey_design(ids = ea,
                    strata=county,
                    weights=final_wt1)

#frq(dat$shocks)
#frq(dat$q_484)
#frq(dat$shock_death)

```

## Overall incidence of shocks

```{r}

shck_mn <- dat %>%
  select(shock_flood:shock_death) %>%
  summarize_all(mean, na.rm=T) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  set_names(nm=c("var_name","freq")) %>%
  left_join(shock_key)
  
#shck_mn

shck_svy <- svyrdat %>%
  select(shock_flood:shock_death) %>%
  summarize_all(survey_mean, na.rm=T) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  set_names(nm=c("var_name","freq"))

shck_mn_svy <- shck_svy %>%
  filter(row_number() %% 2 ==1) %>%
  rename(mn=freq) %>%
  cbind(shock_key)

shck_se_svy <- shck_svy %>%
  filter(row_number() %% 2 == 0) %>%
  rename(se=freq) %>%
  cbind(shock_key)

shck_mn_se_svy <- shck_mn_svy %>%
  mutate(se=shck_se_svy$se,
         lower=mn-1.96*se,
         upper=mn+1.96*se) %>%
  select(1,3,4,2,6,7)

shck_mn_se <- dat %>%
  select(shock_flood:shock_death) %>%
  summarize(across(everything(),
                   list(mn = ~mean(.,na.rm=T), se = ~std.error(.,na.rm=T)))) %>%
#                   .names="{.col}.{.fn}")) %>%
  pivot_longer(cols=1:32,
               names_to=c("discard", "var_name","measure"),
               names_sep="_",
               values_to="value") %>%
  select(-1) %>%
  pivot_wider(names_from=measure,
              values_from=value) %>%
  mutate(lower=mn-1.96*se,
         upper=mn+1.96*se) %>%
  cbind(shock_key) %>%
  select(1,6,7,2:5) %>%
  mutate(overall_rank = rank(-mn)) %>%
  arrange(desc(mn))

#write_csv(shck_mn_se, here("output/tables/shocks/shock incidence overall, unweighted.csv"))
  
shck_mn_se

```

Unweighted

```{r}

ggplot(shck_mn_se, aes(x=mn, y=fct_reorder(shock_lab, mn))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(labels=percent,
                     limits=c(0,1))

```

Weighted

```{r}

ggplot(shck_mn_se_svy, aes(x=mn, y=fct_reorder(shock_lab, mn))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(labels=percent,
                     limits=c(0,1))

```

## Incidence of shocks, by state

```{r}
shck_state_mn_se <- dat %>%
  select(state, shock_flood:shock_death) %>%
  group_by(state) %>%
  summarize(across(shock_flood:shock_death,
                   list(mn = ~mean(., na.rm=T), se = ~std.error(., na.rm=T)))) %>%
  pivot_longer(cols=2:33,
               names_to=c("discard", "var_name","measure"),
               names_sep="_",
               values_to="value") %>%
  select(-2) %>%
  pivot_wider(names_from=measure,
              values_from=value) %>%
  mutate(lower=mn-1.96*se,
         upper=mn+1.96*se) %>%
  cbind(shock_key) %>%
  select(1,2, 7,8,3:6) %>%
  group_by(state) %>%
  mutate(state_rank=rank(-mn)) %>%
  arrange(state,desc(mn)) %>%
  ungroup() 
  
#shck_state_mn_se

#write_csv(shck_state_mn_se, here("output/tables/shocks/shock incidence by state, unweighted.csv"))

```

```{r fig.height=7, fig.width=11}

ggplot(shck_state_mn_se, aes(x=mn, y=fct_reorder(shock_lab, mn))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(labels=percent,
                     limits=c(0,1)) +
  facet_wrap(~state) +
  faceted


```

## Incidence of shocks, by county

```{r}

shck_county_mn_se <- dat %>%
  select(state, county, shock_flood:shock_death) %>%
  group_by(state, county) %>%
  summarize(across(shock_flood:shock_death,
                   list(mn = ~mean(., na.rm=T), se = ~std.error(., na.rm=T)))) %>%
  pivot_longer(cols=3:34,
               names_to=c("discard", "var_name","measure"),
               names_sep="_",
               values_to="value") %>%
  select(-3) %>%
  pivot_wider(names_from=measure,
              values_from=value) %>%
  mutate(lower=mn-1.96*se,
         upper=mn+1.96*se) %>%
  ungroup() %>%
  mutate(shock_lab=rep(shock_labs,13)) %>%
  select(1,2, 3, 8, 4:7) %>%
  group_by(county) %>%
  mutate(county_rank=rank(-mn)) %>%
  arrange(county, desc(mn)) %>%
  ungroup() 
  
#shck_state_mn_se

#write_csv(shck_county_mn_se, here("output/tables/shocks/shock incidence by county, unweighted.csv"))

```

```{r fig.height=10, fig.width=9}

ggplot(shck_county_mn_se, aes(x=mn, y=fct_reorder(shock_lab, mn))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(labels=percent,
                     limits=c(0,1)) +
  facet_wrap(~state + county,
             ncol=4) +
  faceted

```
## Shock clustering

```{r}
shocks <- dat %>%
  select(shock_flood:shock_death)

fa.parallel(shocks,
            cor="tet")
```

```{r}
fa_shocks_5 <- fa(shocks,
                  nfactors=5,
                  cor="tet",
                  scores="tenBerge",
                  fm="ml")

fa_shocks_5
```
ML1: crop shocks

ML3: livestock shocks

ML2: land, erosion, flood

ML5: illness, death

ML4: food prices, illness




## Shock exposure


```{r}
ggplot(dat, aes(shock_exposure_index)) + 
  geom_density(color=light_blue)
```

```{r}
ggplot(dat, aes(shock_exposure_index)) + 
  #geom_bar() + 
  geom_density(color=light_blue) +
  facet_wrap(~state) +
  faceted
```

```{r}
ggplot(dat, aes(shock_exposure_index)) + 
  #geom_bar() + 
  geom_density(color=light_blue) +
  facet_wrap(~county) +
  faceted
```


```{r}
expos <- dat %>%
  group_by(state, county) %>%
  summarize(exposure=mean(shock_exposure_index, na.rm=T),
            se=std.error(shock_exposure_index, na.rm=T)) %>%
  mutate(lower=exposure-1.96*se,
         upper=exposure+1.96*se)

expos
```
Unweighted

```{r}
ggplot(expos, aes(x=exposure, y=fct_reorder(county, exposure))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(limits=c(0,144)) 

```

```{r fig.height=10, fig.width=9}
ggplot(expos, aes(x=exposure, y=fct_reorder(county, exposure))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(limits=c(0,144),
                     breaks=seq(0,125,25)) +
  facet_wrap(~state,
             scales="free",
             ncol=2) + 
  faceted

```

Weighted

```{r}
expos_wt <- svyrdat %>%
  group_by(county) %>%
  summarize(exposure=survey_mean(shock_exposure_index, na.rm=T)) %>%
  mutate(lower=exposure-1.96*exposure_se,
         upper=exposure+1.96*exposure_se)

expos_wt
```

```{r}
ggplot(expos_wt, aes(x=exposure, y=fct_reorder(county, exposure))) + 
  geom_errorbar(aes(xmin=lower, xmax=upper), width=0, size=1, color=light_blue) +
  geom_point(size=3, color=light_blue) +
  labs(x="",
       y="") + 
  scale_x_continuous(limits=c(0,144)) 

```

# Ability to recover

# 
